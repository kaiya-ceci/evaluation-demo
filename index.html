<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>å¤–éƒ¨è©•åˆ†éª¨æ¶</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif; margin: 16px; }
    .row { display: flex; gap: 16px; align-items: flex-start; }
    .col { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
    .left { width: 45%; min-width: 320px; }
    .right { width: 55%; min-width: 360px; }
    select, input, textarea, button { font-size: 14px; padding: 8px; }
    textarea { width: 100%; min-height: 90px; }
    .qitem { padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
    .qitem:hover { background: #fafafa; }
    .qitem.active { border-color: #4f46e5; background: #eef2ff; }
    .label { font-size: 12px; color: #555; margin-top: 10px; margin-bottom: 4px; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .hint { color: #666; font-size: 12px; margin-top: 8px; }
    .status { margin-top: 10px; }
  </style>
</head>
<body>

<h2>å¤–éƒ¨è©•åˆ†ï¼ˆäº’å‹•éª¨æ¶ç‰ˆï¼‰</h2>

<h3 style="margin-top:10px;">è©•åˆ†è€…åŸºæœ¬è³‡æ–™</h3>

<div class="grid2" style="margin-top: 8px;">
  <div>
    <div class="label">ç§‘å®¤ï¼ˆå¿…é¸ï¼‰</div>
    <select id="dept" style="width:100%;">
      <option value="">è«‹é¸æ“‡</option>
      <option value="é«˜éšä¸»ç®¡">é«˜éšä¸»ç®¡</option>
      <option value="æ±¡æ°´å·¥ç¨‹ç§‘">æ±¡æ°´å·¥ç¨‹ç§‘</option>
      <option value="æ±¡æ°´è¨­æ–½ç§‘">æ±¡æ°´è¨­æ–½ç§‘</option>
      <option value="æ±¡æ°´ç‡Ÿé‹ç§‘">æ±¡æ°´ç‡Ÿé‹ç§‘</option>
    </select>
  </div>
  <div>
    <div class="label">è·ç¨±ï¼ˆå¿…å¡«ï¼‰</div>
    <input id="title" type="text" placeholder="ä¾‹å¦‚ï¼šå·¥ç¨‹å¸" style="width:100%;" />
  </div>
</div>

<div style="margin-top: 10px;">
  <div class="label">å§“åï¼ˆå¿…å¡«ï¼‰</div>
  <input id="name" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" style="width:100%;" />
</div>

<div style="margin-top: 12px; display:flex; gap:10px; align-items:center;">
  <button id="btnStart" type="button">é–‹å§‹è©•åˆ†</button>
  <span class="hint">ä¸‰é …å¡«å®Œæ‰å¯é–‹å§‹</span>
</div>

<hr style="margin: 14px 0; border:0; border-top:1px solid #eee;" />

<div class="label">åˆ†é¡</div>
<select id="category"></select>


<div class="row" style="margin-top: 12px;">
  <div class="col left">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <strong>é¡Œç›®æ¸…å–®</strong>
      <span class="hint">é¡Œç›®æ¸…å–®</span>
    </div>
    <div id="qList" style="margin-top: 10px; max-height: 70vh; overflow: auto;"></div>
  </div>

  <div class="col right">
    <strong>é¡Œç›®å…§å®¹</strong>

    <div class="label">é¡Œç›®</div>
    <div id="qText" style="white-space: pre-wrap; border:1px solid #eee; border-radius:8px; padding:10px; min-height:60px;"></div>

    <div class="label">ç°¡ç­”</div>
    <div id="aText" style="white-space: pre-wrap; border:1px solid #eee; border-radius:8px; padding:10px; min-height:60px;"></div>
    <div class="label">è©³ç­”</div>
    <div id="aLongText" style="white-space: pre-wrap; border:1px solid #eee; border-radius:8px; padding:10px; min-height:90px;"></div>


    <div class="grid2">
      <div>
        <div class="label">å…§å®¹æ­£ç¢ºæ€§ Aï¼ˆ0~50ï¼‰</div>
        <input id="scoreA" type="number" min="0" max="50" step="1" placeholder="0~50" style="width:100%;" />
      </div>
      <div>
        <div class="label">èªæ„å®Œæ•´æ€§ Bï¼ˆ0~50ï¼‰</div>
        <input id="scoreB" type="number" min="0" max="50" step="1" placeholder="0~50" style="width:100%;" />
      </div>
    </div>

    <div class="label">æœ¬é¡è©•èªï¼ˆå¯ç©ºç™½ï¼‰</div>
    <textarea id="comment" placeholder="å¯ç•™ç©º"></textarea>

    <div style="margin-top: 12px; display:flex; gap:10px; align-items:center;">
      <button id="btnSave">å„²å­˜æœ¬é¡çµæœ</button>
      <button id="btnClear" type="button">æ¸…ç©ºæœ¬é¡Œè¼¸å…¥</button>
    </div>

    <div class="col" style="margin-top:12px; border-color:#eee;">
      <strong>æœ¬æ¬¡è©•åˆ†ç¸½è¦½</strong>
      <div class="hint" id="progressText" style="margin-top:6px;">å°šæœªé–‹å§‹</div>
    
      <div class="grid2" style="margin-top:10px;">
        <div>
          <div class="label">ç¸½åˆ†ï¼ˆA+Bï¼‰</div>
          <div id="totalScore" style="font-size:20px; font-weight:700;">-</div>
        </div>
        <div>
          <div class="label">å®Œæˆåº¦</div>
          <div id="doneCount" style="font-size:20px; font-weight:700;">0/5</div>
        </div>
      </div>
    
      <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
        <button id="btnSubmit" type="button">ç¢ºèªé€å‡ºï¼ˆå®Œæˆå¾Œé–å®šï¼‰</button>
        <span class="hint">éœ€äº”é¡çš†å¡« A/B æ‰èƒ½é€å‡º</span>
      </div>
    </div>

    <div class="status" id="status"></div>
    <div class="hint">ç›®å‰å„²å­˜æ˜¯ã€Œæ¯æŒ‰ä¸€æ¬¡å°±æ–°å¢ä¸€ç­†ã€ï¼šåªæ˜¯å…ˆé©—è­‰äº’å‹•èˆ‡å¯«å…¥ã€‚ä¸‹ä¸€æ­¥å†æ”¹æˆã€ŒåŒä¸€äººåŒä¸€ç­†æ›´æ–°ã€ã€‚</div>
  </div>
</div>

<script type="module">
 import { initializeApp } 
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

  import { 
    getFirestore, doc, getDoc, updateDoc, serverTimestamp,
    addDoc, collection 
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // âœ… ä½ çš„ Firebase è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyBqSDWpIR_Bm2CVdnObkkuopOBrxgoXlH0",
    authDomain: "tcswg-ai-qa.firebaseapp.com",
    projectId: "tcswg-ai-qa"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);  
  let EVAL_ID = null;
  let hasUnsavedOrUnsubmittedWork = false;
  let isSubmitted = false;



  // âœ… åˆ†é¡ï¼ˆé€™ä¸€å®šè¦æ˜¯ã€Œé™£åˆ—ã€ï¼‰
  const CATEGORIES = [
    "åŒ–ç³æ± è™•ç†",
    "æ”¿ç­–èˆ‡æ³•è¦",
    "æ–½å·¥èˆ‡æŠ€è¡“",
    "æ¥ç®¡æµç¨‹èˆ‡æœŸé™",
    "è²»ç”¨èˆ‡è£œåŠ©"    
  ];
  
  // âœ… åˆ†é¡ä»£ç¢¼ï¼ˆé€™æ˜¯ç‰©ä»¶ï¼Œä¸æ˜¯é™£åˆ—ï¼‰
  const CATEGORY_KEYS = {
    "åŒ–ç³æ± è™•ç†": "septic",
    "æ¥ç®¡æµç¨‹èˆ‡æœŸé™": "connection",
    "æ–½å·¥èˆ‡æŠ€è¡“": "construction",
    "è²»ç”¨èˆ‡è£œåŠ©": "subsidy",
    "æ”¿ç­–èˆ‡æ³•è¦": "policy"
  };

  let QUESTIONS = {};

  async function loadQuestions() {
    const res = await fetch("./questions.json");
    if (!res.ok) throw new Error("è®€å– questions.json å¤±æ•—");
    QUESTIONS = await res.json();
  }


  // --- UI ç‹€æ…‹ ---
  let currentCategory = CATEGORIES[0];
  let currentQuestion = null;  // âœ… å…ˆä¸è¦ç¢° QUESTIONS


  const elCat = document.getElementById("category");
  const elList = document.getElementById("qList");
  const elQ = document.getElementById("qText");
  const elA = document.getElementById("aText");
  const elALong = document.getElementById("aLongText");
  const elScoreA = document.getElementById("scoreA");
  const elScoreB = document.getElementById("scoreB");
  const elComment = document.getElementById("comment");
  const elStatus = document.getElementById("status");
  const elDept = document.getElementById("dept");
  const elTitle = document.getElementById("title");
  const elName = document.getElementById("name");
  const elBtnStart = document.getElementById("btnStart");
  const elProgressText = document.getElementById("progressText");
  const elTotalScore = document.getElementById("totalScore");
  const elDoneCount = document.getElementById("doneCount");
  const elBtnSubmit = document.getElementById("btnSubmit");

  function setScoringEnabled(enabled) {
    elCat.disabled = !enabled;
    document.getElementById("btnSave").disabled = !enabled;
    document.getElementById("btnClear").disabled = !enabled;
    elScoreA.disabled = !enabled;
    elScoreB.disabled = !enabled;
    elComment.disabled = !enabled;
  }
  
  function validateRaterInfo() {
    const dept = elDept.value.trim();
    const title = elTitle.value.trim();
    const name = elName.value.trim();
  
    if (!dept) return { ok:false, msg:"è«‹å…ˆé¸æ“‡ç§‘å®¤" };
    if (!title) return { ok:false, msg:"è«‹å…ˆå¡«å¯«è·ç¨±" };
    if (!name) return { ok:false, msg:"è«‹å…ˆå¡«å¯«å§“å" };
  
    return { ok:true, dept, title, name };
  }



  async function loadCategoryInputs() {
    // é è¨­æ¸…ç©º
    elScoreA.value = "";
    elScoreB.value = "";
    elComment.value = "";
  
    try {
      const snap = await getDoc(doc(db, "scores", EVAL_ID));
      if (!snap.exists()) return;
  
      const data = snap.data();
      console.log("currentCategory =", currentCategory);
      console.log("categories keys =", Object.keys(data?.categories || {}), data?.categories);
      const catData = 
        data?.categories?.[currentCategory] ||
        data?.categories?.[CATEGORY_KEYS[currentCategory]];
      
      if (!catData) {
        console.log("â—æ‰¾ä¸åˆ°é€™å€‹åˆ†é¡çš„è³‡æ–™");
        return;
      }
  
      // å¸¶å›æ—¢æœ‰è³‡æ–™
      elScoreA.value = (catData.scoreA ?? "") === null ? "" : (catData.scoreA ?? "");
      elScoreB.value = (catData.scoreB ?? "") === null ? "" : (catData.scoreB ?? "");
      elComment.value = catData.comment ?? "";
    } catch (err) {
      console.error(err);
      setStatus("è®€å–æ—¢æœ‰åˆ†æ•¸å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰", false);
    }
  }

    
  function setStatus(msg, ok=true) {
    elStatus.innerHTML = ok ? `<span style="color:green;">âœ… ${msg}</span>` : `<span style="color:#b91c1c;">âŒ ${msg}</span>`;
  }

  function renderCategoryOptions() {
    elCat.innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join("");
    elCat.value = currentCategory;
  }

  function renderQuestionList() {
    const qs = QUESTIONS[currentCategory] || [];
    elList.innerHTML = "";
    qs.forEach(q => {
      const div = document.createElement("div");
      div.className = "qitem" + (q.id === currentQuestion?.id ? " active" : "");
      div.innerHTML = `<div><strong>${q.id}</strong></div><div style="margin-top:4px; white-space:pre-wrap;">${q.q}</div>`;
      div.onclick = () => {
        currentQuestion = q;
        renderQuestionList();
        renderQuestionContent();
        setStatus("å·²åˆ‡æ›é¡Œç›®ï¼ˆå°šæœªå„²å­˜ï¼‰", true);
      };
      elList.appendChild(div);
    });
  }

  function renderQuestionContent() {
    elQ.textContent = currentQuestion?.q || "";
    elA.textContent = currentQuestion?.aShort || "";
    elALong.textContent = currentQuestion?.aLong || "";
  }

  function clearInputs() {
    elScoreA.value = "";
    elScoreB.value = "";
    elComment.value = "";
  }

  function validateScores() {
    // å…è¨±ç©ºç™½å…ˆä¸ç®¡ï¼Œäº’å‹•éª¨æ¶å…ˆè·‘é€šï¼›ä¸‹ä¸€æ­¥å†åŠ åš´æ ¼è¦å‰‡
    const a = elScoreA.value === "" ? null : Number(elScoreA.value);
    const b = elScoreB.value === "" ? null : Number(elScoreB.value);

    if (a !== null && (Number.isNaN(a) || a < 0 || a > 50)) return { ok:false, msg:"A å¿…é ˆæ˜¯ 0~50" };
    if (b !== null && (Number.isNaN(b) || b < 0 || b > 50)) return { ok:false, msg:"B å¿…é ˆæ˜¯ 0~50" };
    return { ok:true, a, b };
  }
  
  function isCategoryComplete(catData) {
    // ä½ è¦çš„è¦å‰‡ï¼šAã€B éƒ½å¿…å¡«ï¼Œ0~50
    if (!catData) return false;
    const a = catData.scoreA;
    const b = catData.scoreB;
    if (a === null || a === "" || typeof a === "undefined") return false;
    if (b === null || b === "" || typeof b === "undefined") return false;
    if (typeof a !== "number" || typeof b !== "number") return false;
    if (a < 0 || a > 50 || b < 0 || b > 50) return false;
    return true;
  }
  
  async function refreshSummary() {
    if (!EVAL_ID) {
      elProgressText.textContent = "å°šæœªå»ºç«‹è©•åˆ†ç´€éŒ„";
      elTotalScore.textContent = "-";
      elDoneCount.textContent = "0/5";
      elBtnSubmit.disabled = true;
      return;
    }
  
    try {
      const snap = await getDoc(doc(db, "scores", EVAL_ID));
      if (!snap.exists()) return;
  
      const data = snap.data();
      const cats = data.categories || {};
      isSubmitted = (data.submitted === true);
  
      let done = 0;
      let total = 0;
  
      for (const cat of CATEGORIES) {
        const cd = cats[cat] || cats[CATEGORY_KEYS[cat]];
        if (isCategoryComplete(cd)) {
          done += 1;
          total += (cd.scoreA + cd.scoreB);
        }
      }
  
      elDoneCount.textContent = `${done}/5`;
      elTotalScore.textContent = done === 0 ? "-" : String(total);
      elProgressText.textContent = done === 5
        ? "âœ… äº”é¡çš†å®Œæˆï¼Œå¯ä»¥é€å‡º"
        : `å°šæœªå®Œæˆï¼šé‚„å·® ${5 - done} é¡`;
  
      elBtnSubmit.disabled = (done !== 5) || (data.submitted === true);
      if (data.submitted === true) {
        elProgressText.textContent = "âœ… å·²é€å‡ºï¼ˆå·²é–å®šï¼‰";
      }
      // ğŸ”¥ æ›´æ–°åˆ†é¡ä¸‹æ‹‰é¡¯ç¤ºå®Œæˆç‹€æ…‹
      elCat.innerHTML = CATEGORIES.map(cat => {
        const cd = cats[cat] || cats[CATEGORY_KEYS[cat]];
        const isDone = isCategoryComplete(cd);
        const mark = isDone ? " âœ…" : " âšª";
        return `<option value="${cat}">${cat}${mark}</option>`;
      }).join("");
      
      elCat.value = currentCategory; // ä¿æŒåŸæœ¬é¸ä¸­çš„åˆ†é¡
    } catch (err) {
      console.error(err);
      setStatus("è®€å–ç¸½è¦½å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰", false);
    }
  }

  
  // --- äº‹ä»¶ ---
  elCat.addEventListener("change", async () => {
    currentCategory = elCat.value;
    currentQuestion = QUESTIONS[currentCategory][0];
    renderQuestionList();
    renderQuestionContent();
  
    await loadCategoryInputs(); // âœ… æ”¹æˆè¼‰å…¥æœ¬åˆ†é¡å·²å­˜çš„åˆ†æ•¸/è©•èª
    await refreshSummary();
    setStatus("å·²åˆ‡æ›åˆ†é¡ï¼ˆå·²è¼‰å…¥æœ¬åˆ†é¡åˆ†æ•¸/è©•èªï¼‰", true);
  });

  document.getElementById("btnClear").addEventListener("click", () => {
    clearInputs();
    setStatus("å·²æ¸…ç©ºæœ¬é¡Œè¼¸å…¥", true);
  });
  elBtnStart.addEventListener("click", async () => {
    const v = validateRaterInfo();
    if (!v.ok) {
      setStatus(v.msg, false);
      return;
    }
  
    try {
      const docRef = await addDoc(collection(db, "scores"), {
        rater: {
          dept: v.dept,
          title: v.title,
          name: v.name
        },
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
  
      EVAL_ID = docRef.id; // ğŸ”¥ é€™ä¸€è¡Œæ˜¯é—œéµ
      hasUnsavedOrUnsubmittedWork = true;
      isSubmitted = false;
  
      setScoringEnabled(true);
      await loadCategoryInputs();
      await refreshSummary();
      setStatus("å·²å»ºç«‹æ–°çš„è©•åˆ†ç´€éŒ„ï¼Œå¯ä»¥é–‹å§‹è©•åˆ†", true);
  
    } catch (err) {
      console.error(err);
      setStatus("å»ºç«‹è©•åˆ†ç´€éŒ„å¤±æ•—", false);
    }
  });



  document.getElementById("btnSave").addEventListener("click", async () => {
        const r = validateRaterInfo();
        if (!r.ok) { setStatus("è«‹å…ˆå®Œæˆç§‘å®¤/è·ç¨±/å§“åï¼ŒæŒ‰ã€Œé–‹å§‹è©•åˆ†ã€", false); return; }
    
        if (!currentQuestion) {
          setStatus("æ²’æœ‰é¸åˆ°é¡Œç›®", false);
          return;
        }
        const v = validateScores();
        if (!v.ok) {
          setStatus(v.msg, false);
          return;
        }

    try {
         
      await updateDoc(doc(db, "scores", EVAL_ID), {
        updatedAt: serverTimestamp(),
        [`categories.${currentCategory}`]: {
          scoreA: v.a,
          scoreB: v.b,
          comment: elComment.value || "",
          updatedAt: serverTimestamp()
        }
      });
      
      await refreshSummary();
      setStatus("å·²å„²å­˜ï¼ˆå·²å¯«å…¥ Firestoreï¼‰", true);
      hasUnsavedOrUnsubmittedWork = true;
    } catch (err) {
      console.error(err);
      setStatus("å¯«å…¥å¤±æ•—ï¼Œè«‹çœ‹ Console", false);
    }
  });
  elBtnSubmit.addEventListener("click", async () => {
    if (!EVAL_ID) { setStatus("å°šæœªå»ºç«‹è©•åˆ†ç´€éŒ„", false); return; }
  
    const ok = confirm("ç¢ºèªé€å‡ºå¾Œå°‡é–å®šä¸å¯ä¿®æ”¹ã€‚ç¢ºå®šè¦é€å‡ºå—ï¼Ÿ");
    if (!ok) return;
  
    try {
      const snap = await getDoc(doc(db, "scores", EVAL_ID));
      const data = snap.data() || {};
      const cats = data.categories || {};
  
      // å†ç®—ä¸€æ¬¡ totalï¼ˆé¿å…å‰ç«¯ç‹€æ…‹ä¸ä¸€è‡´ï¼‰
      let total = 0;
      for (const cat of CATEGORIES) {
        const cd = cats[cat] || cats[CATEGORY_KEYS[cat]];
        if (!isCategoryComplete(cd)) {
          setStatus("ä»æœ‰åˆ†é¡æœªå®Œæˆï¼ˆA/B å¿…å¡«ï¼‰", false);
          return;
        }
        total += (cd.scoreA + cd.scoreB);
      }
  
      await updateDoc(doc(db, "scores", EVAL_ID), {
        submitted: true,
        totalScore: total,
        submittedAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      isSubmitted = true;
      hasUnsavedOrUnsubmittedWork = false;
  
      // é–å®š
      setScoringEnabled(false);
      elBtnSubmit.disabled = true;
  
      setStatus("âœ… å·²é€å‡ºä¸¦é–å®š", true);
      await refreshSummary();
    } catch (err) {
      console.error(err);
      setStatus("é€å‡ºå¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰", false);
    }
  });

  // --- åˆå§‹åŒ– ---
  setScoringEnabled(false);  // âœ… ä¸€é€²ä¾†å…ˆé–
  
  try {
    await loadQuestions(); // âœ… å…ˆæŠŠ 200 é¡Œè¼‰é€²ä¾†
    console.log("é¡Œåº«åˆ†é¡ keys =", Object.keys(QUESTIONS));
  
    // âœ… è®“åˆ†é¡ä¸‹æ‹‰ç”¨ã€Œä½ æ—¢æœ‰çš„ CATEGORIES é †åºã€ï¼Œè€Œä¸æ˜¯ Object.keys çš„éš¨æ©Ÿé †åº
    currentCategory = CATEGORIES[0];
    currentQuestion = (QUESTIONS[currentCategory] && QUESTIONS[currentCategory][0]) ? QUESTIONS[currentCategory][0] : null;
  
    renderCategoryOptions();
    renderQuestionList();
    renderQuestionContent();
  
    // âŒ åˆå§‹åŒ–æ™‚å…ˆä¸è¦ loadCategoryInputsï¼ˆå› ç‚ºé‚„æ²’æŒ‰é–‹å§‹è©•åˆ†ï¼‰
    setStatus("é¡Œåº«å·²è¼‰å…¥ã€‚è«‹å…ˆå¡«ç§‘å®¤/è·ç¨±/å§“åï¼ŒæŒ‰ã€Œé–‹å§‹è©•åˆ†ã€å¾Œå†è©•åˆ†", true);
  } catch (err) {
    console.error(err);
    setStatus("é¡Œåº«è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª questions.json è·¯å¾‘èˆ‡æ˜¯å¦æœ‰ä¸Šå‚³åˆ° GitHub", false);
  }

  window.addEventListener("beforeunload", (e) => {
    if (!EVAL_ID) return;                 // é‚„æ²’é–‹å§‹è©•åˆ†ä¸ç”¨æ“‹
    if (isSubmitted) return;              // å·²é€å‡ºä¸ç”¨æ“‹
    if (!hasUnsavedOrUnsubmittedWork) return;
  
    e.preventDefault();
    e.returnValue = ""; // é€™è¡Œæ˜¯è§¸ç™¼ç€è¦½å™¨å…§å»ºæç¤ºçš„é—œéµ
  });
  

  

</script>
</body>
</html>
