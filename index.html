<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>è‡ºä¸­å¸‚æ°´åˆ©å±€AIå°å¹«æ‰‹æ¸¬è©¦çµæœè©•åˆ†</title>
  <style>
    .row { display: flex; gap: 16px; align-items: flex-start; }
    .left, .right { flex: 1; min-width: 0; }
    select, input, textarea, button { font-size: 14px; padding: 8px; }
    textarea { width: 100%; min-height: 90px; }
    .qitem { padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
    .qitem:hover { background: #fafafa; }
    .qitem.active { border-color: #f1bb63; background: #fffbee; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .hint { color: #666; font-size: 12px; margin-top: 8px; }
    .status { margin-top: 0; padding: 0; border: 0; background: transparent; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      margin: 0;
      background: #b2d2d9;
      color: #111827;
    }
    h2 { margin-bottom: 10px; }
    hr { border: 0; border-top: 1px solid #e5e7eb; }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 20px;
    }
    .col {
      background: #fff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 6px 18px rgba(17, 24, 39, 0.06);
      padding: 16px;
      border-radius: 14px;
      height: 100%;
    }

    .label {
      font-weight: 600;
      color: #374151;
      margin-top: 14px;
      margin-bottom: 6px;
    }

    .startRow{
      margin-top: 12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .miniStatus{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      display: inline-block;
    }
    .miniStatus.ok{
      background:#ecfdf5;
      color:#047857;
      border:1px solid #a7f3d0;
    }
    .miniStatus.bad{
      background:#fef2f2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }

    .scoreCard{
      background:#f0fcff;
      border:1px solid #0ca59c;
      border-radius:14px;
      padding:16px 18px;
      margin-top:16px;
      box-shadow:0 6px 18px rgba(17, 24, 39, 0.06);
    }
    .scoreCardTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight: 800;
      color:#111827;
    }

    .sectionCard{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:16px 18px;
      margin-top:16px;
      box-shadow:0 6px 18px rgba(17, 24, 39, 0.06);
    }

    #aText, #aLongText{
      padding: 14px 16px !important;
      line-height: 1.6;
    }

    .contentCard{
      white-space: pre-wrap;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 14px;
      min-height: 70px;
      background: #fff;
    }

    @media (max-width: 900px) {
      /* è®“å¤–æ¡†ä¸è¦çœ‹èµ·ä¾†æ“ æˆä¸€æ¢ */
      .container{
        padding: 14px 12px;
      }
    
      /* âœ… ä¸‰æ¬„ â†’ å–®æ¬„ï¼ˆé‡é»ï¼ä¸è¦ç”¨ flexï¼Œç›´æ¥æ”¹ grid ä¸€æ¬„æœ€ä¸æœƒæ€ªï¼‰ */
      .row3{
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
      }
    
      /* å¡ç‰‡æœ¬èº«æ’æ»¿ */
      .col{
        width: 100%;
      }
    
      /* è®“æ‰€æœ‰è¼¸å…¥å…ƒä»¶ 100% */
      select, input, textarea, button{
        width: 100%;
        max-width: 100%;
      }
    
      /* å·¦æ¬„é¡Œç›®æ¸…å–®ï¼šæ‰‹æ©Ÿä¸è¦å¤ªé•·ï¼Œä¸ç„¶ä¸€ç›´æ»‘ */
      .col.left #qList{
        max-height: 42vh;
        overflow: auto;
      }
    
      /* âœ… ä¸­æ¬„ç­”æ¡ˆï¼šæ‰‹æ©Ÿä¸è¦å›ºå®š 70vhï¼Œæ”¹æˆè‡ªç„¶é«˜åº¦ + ä¸Šé™ */
      .col.mid .answerPane{
        height: auto;
        max-height: 45vh;
        overflow-y: auto;
        overflow-x: hidden;
      }
    
      /* âœ… å³æ¬„è©•åˆ†ï¼šæ‰‹æ©Ÿä¸è¦ stickyï¼ˆä¸ç„¶æœƒå¡ç•«é¢ï¼‰ */
      .col.right .scorePane{
        position: static;
        top: auto;
      }
    
      /* grid2ï¼šæ‰‹æ©Ÿæ”¹å–®æ¬„ï¼ˆä½ åŸæœ¬æœ‰ï¼Œä½†æˆ‘ä¹Ÿä¸€èµ·ä¿éšªå¯«é€²ä¾†ï¼‰ */
      .grid2{
        grid-template-columns: 1fr !important;
      }
    }
    .container * { box-sizing: border-box; }

    /* =========================
       âœ… ä¸‰æ¬„ç‰ˆé¢ï¼šé¡Œç›®ï½œç­”æ¡ˆï½œè©•åˆ†
       ========================= */
    .row3{
      display: grid;
      grid-template-columns: 1.05fr 1.15fr 0.9fr; /* å·¦ä¸­å³æ¯”ä¾‹ï¼Œå¯å†èª¿ */
      gap: 16px;
      align-items: start;
    }
    
    .col.mid { min-width: 0; }
    .col.left, .col.right { min-width: 0; }
    
    /* å·¦æ¬„é¡Œç›®æ¸…å–®æ²å‹• */
    .col.left #qList{
      max-height: 70vh;
      overflow: auto;
    }
    
    /* ä¸­æ¬„ç­”æ¡ˆå›ºå®šé«˜åº¦æ²å‹• */
    .col.mid .answerPane{
      height: 70vh;              /* âœ… å›ºå®šé«˜åº¦ â†’ ä¸æœƒå› ç­”æ¡ˆé•·çŸ­æ¨å‹•è©•åˆ† */
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 6px;
      -webkit-overflow-scrolling: touch;
    }
    
    /* å³æ¬„è©•åˆ† sticky */
    .col.right .scorePane{
      position: sticky;
      top: 12px;
    }
    
    /* è®“æ²å‹•åœ¨ iOS/æ‰‹æ©Ÿä¸Šæ›´é †ï¼ˆå¯æœ‰å¯ç„¡ï¼‰ */
    .answerPane{
      -webkit-overflow-scrolling: touch;
    }
    /* =========================
       âœ… Mobile / RWD Fix (å¿…åŠ )
       ========================= */
    @media (max-width: 900px){
    
      /* æ•´é«”ç•™ç™½ç¸®å°ï¼Œä¸è¦æ“  */
      .container{
        padding: 14px 12px;
      }
    
      /* âœ… ä¸‰æ¬„ â†’ å–®æ¬„ï¼ˆé—œéµï¼ï¼‰ */
      .row3{
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 12px !important;
      }
    
      /* æ¯å€‹æ¬„ä½å¡ç‰‡æ’æ»¿ */
      .col{
        width: 100% !important;
        padding: 14px !important;
        border-radius: 14px;
      }
    
      /* åˆ†é¡ä¸‹æ‹‰é¸å–®å¤ªçª„çš„å•é¡Œ */
      #category{
        width: 100% !important;
      }
    
      /* âœ… å·¦æ¬„é¡Œç›®æ¸…å–®ï¼šé™åˆ¶é«˜åº¦ï¼Œæ»‘å°±å¥½ */
      .col.left #qList{
        max-height: 40vh !important;
        overflow: auto !important;
      }
    
      /* é¡Œç›®é …ç›®å­—è®Šå¤§ä¸€é»ã€é–“è·èˆ’æœ */
      .qitem{
        padding: 12px !important;
        margin-bottom: 10px !important;
      }
      .qitem strong{
        font-size: 16px;
      }
    
      /* âœ… ç­”æ¡ˆå€ï¼šä¸è¦å›ºå®š 70vhï¼Œæ‰‹æ©Ÿç”¨ max-height æ§åˆ¶ */
      .col.mid .answerPane{
        height: auto !important;
        max-height: 45vh !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
      }
    
      /* å…§å®¹å¡ç‰‡ï¼šå­—ç´šã€è¡Œé«˜èª¿èˆ’æœ */
      .contentCard{
        font-size: 15px !important;
        line-height: 1.7 !important;
        padding: 12px !important;
      }
    
      /* âœ… å³æ¬„è©•åˆ†ï¼šæ‰‹æ©Ÿä¸è¦ stickyï¼ˆæœƒå¡ç•«é¢ï¼‰ */
      .col.right .scorePane{
        position: static !important;
        top: auto !important;
      }
    
      /* grid2ï¼šå…©æ¬„è¼¸å…¥åœ¨æ‰‹æ©Ÿè®Šå–®æ¬„ */
      .grid2{
        grid-template-columns: 1fr !important;
        gap: 10px !important;
      }
    
      /* æ‰€æœ‰è¡¨å–®å…ƒç´ éƒ½æ’æ»¿ */
      select, input, textarea, button{
        width: 100% !important;
        max-width: 100% !important;
        font-size: 15px !important;
      }
    
      /* è©•åˆ†å¡å…§æŒ‰éˆ•ï¼šæ‰‹æ©Ÿæ”¹æˆç›´æ’æ¯”è¼ƒä¸æ“  */
      .scoreCard > div[style*="display:flex"]{
        flex-direction: column !important;
        align-items: stretch !important;
      }
    }
      /* âœ… è©•åˆ†èªªæ˜æ¡†ï¼ˆè—æ¡†å…§çš„å°èªªæ˜ï¼‰ */
      .scoreHelp{
        margin-top: 10px;
        padding: 10px 12px;
        background: #ffffff;
        border: 1px dashed #bfe7e4;
        border-radius: 12px;
      }
      
      .scoreHelpTitle{
        font-weight: 800;
        font-size: 13px;
        color: #0f766e;
        margin-bottom: 4px;
      }
      
      .scoreHelpText{
        font-size: 13px;
        line-height: 1.6;
        color: #374151;
      }
    /* âœ… è®“è©•åˆ†ç¸½è¦½çš„ä¸‰æ ¼åœ¨æ¡Œæ©Ÿæ’æˆä¸‰æ¬„ï¼ˆå¯é¸ï¼‰ */
    @media (min-width: 900px){
      .sectionCard .grid2{
        grid-template-columns: repeat(3, 1fr);
      }
    }

    
  </style>
</head>
<body>
  <div class="container">

    <h2>è‡ºä¸­å¸‚æ°´åˆ©å±€AIå°å¹«æ‰‹æ¸¬è©¦çµæœè©•åˆ†</h2>

    <h3 style="margin-top:30px;">è©•åˆ†è€…åŸºæœ¬è³‡æ–™</h3>

    <div class="grid2" style="margin-top: 8px;">
      <div>
        <div class="label">ç§‘å®¤ï¼ˆå¿…é¸ï¼‰</div>
        <select id="dept" style="width:100%;">
          <option value="">è«‹é¸æ“‡</option>
          <option value="é«˜éšä¸»ç®¡">é«˜éšä¸»ç®¡</option>
          <option value="æ±¡æ°´å·¥ç¨‹ç§‘">æ±¡æ°´å·¥ç¨‹ç§‘</option>
          <option value="æ±¡æ°´è¨­æ–½ç§‘">æ±¡æ°´è¨­æ–½ç§‘</option>
          <option value="æ±¡æ°´ç‡Ÿé‹ç§‘">æ±¡æ°´ç‡Ÿé‹ç§‘</option>
        </select>
      </div>
      <div>
        <div class="label">è·ç¨±ï¼ˆå¿…å¡«ï¼‰</div>
        <input id="title" type="text" placeholder="ä¾‹å¦‚ï¼šå·¥ç¨‹å¸" style="width:100%;" />
      </div>
    </div>

    <div style="margin-top: 10px;">
      <div class="label">å§“åï¼ˆå¿…å¡«ï¼‰</div>
      <input id="name" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" style="width:100%;" />
    </div>

    <div class="startRow">
      <button id="btnStart" type="button">é–‹å§‹è©•åˆ†</button>
      <span class="hint">åŸºæœ¬è³‡æ–™å¡«å¯«å®Œæˆæ‰å¯é–‹å§‹è©•åˆ†</span>
      <span id="startStatus" class="miniStatus"></span>
    </div>

    <hr style="margin: 14px 0; border:0; border-top:1px solid #eee;" />

    <div class="label">åˆ†é¡</div>
    <select id="category"></select>

    <div class="row3" style="margin-top: 12px;">
    
      <!-- å·¦æ¬„ï¼šé¡Œç›®æ¸…å–®ï¼ˆåŸå°ä¸å‹•ï¼‰ -->
      <div class="col left">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>é¡Œç›®æ¸…å–®</strong>
          <span class="hint">å¯é»é¸ä¸Šæ–¹é¸å–®åˆ‡æ›</span>
        </div>
        <div id="qList" style="margin-top: 10px;"></div>
      </div>
    
      <!-- âœ… ä¸­æ¬„ï¼šç­”æ¡ˆå€ï¼ˆå¾åŸæœ¬å³æ¬„æ¬éä¾†ï¼‰ -->
      <div class="col mid">
        <div class="answerPane">
          <div class="label">ç°¡ç­”</div>
          <div id="aText" class="contentCard"></div>
    
          <div class="label">è©³ç­”</div>
          <div id="aLongText" class="contentCard"></div>
        </div>
      </div>
    
      <!-- âœ… å³æ¬„ï¼šè©•åˆ†å€ï¼ˆä¿ç•™ä½ åŸæœ¬ scorePane è£¡çš„æ‰€æœ‰å…§å®¹ï¼‰ -->
      <div class="col right">
        <div class="scorePane">
    
          <!-- ===== ä¸‹é¢æ•´åŒ…ï¼šä½ åŸæœ¬ scorePane è£¡çš„å…§å®¹åŸå°ä¸å‹•è²¼é€²ä¾† ===== -->
          <div class="scoreCard">
            <div class="scoreCardTitle">
              <span id="scoreTitle">æœ¬é¡è©•åˆ†</span>            
            </div>
            <!-- âœ… è©•åˆ†èªªæ˜ï¼ˆæ–°å¢ï¼‰ -->
            <div class="scoreHelp">
              <div class="scoreHelpTitle">è©•åˆ†æ–¹å¼</div>
              <div class="scoreHelpText">
                æœ¬æ¸¬è©¦æ¡ã€Œåˆ†é¡è©•åˆ†ã€ï¼Œä¸éœ€é€é¡Œè©•åˆ†ã€‚æ¯é¡ä¾
                <b>å…§å®¹æ­£ç¢ºæ€§ A</b> èˆ‡ <b>èªæ„å®Œæ•´æ€§ B</b> å„è©• <b>0~50</b> åˆ†ï¼Œ
                æ¯é¡æ»¿åˆ† <b>100</b> åˆ†ï¼›äº”é¡åˆè¨ˆç¸½åˆ†æ»¿åˆ† <b>500</b> åˆ†ã€‚
              </div>
            </div>
    
            <div class="grid2" style="margin-top:10px;">
              <div>
                <div class="label">å…§å®¹æ­£ç¢ºæ€§ Aï¼ˆ0~50ï¼‰</div>
                <input id="scoreA" type="number" min="0" max="50" step="1" placeholder="0~50" style="width:100%;" />
              </div>
              <div>
                <div class="label">èªæ„å®Œæ•´æ€§ Bï¼ˆ0~50ï¼‰</div>
                <input id="scoreB" type="number" min="0" max="50" step="1" placeholder="0~50" style="width:100%;" />
              </div>
            </div>
    
            <div class="label">è©•èªï¼ˆå¯ç©ºç™½ï¼Œæœ€å¤š 200 å­—ï¼‰</div>
            <textarea id="comment" placeholder="å¯ç•™ç©º" maxlength="200"></textarea>
            <div class="hint" style="text-align:right;">
              <span id="commentCount">0</span>/200
            </div>
    
            <div style="margin-top: 12px; display:flex; gap:10px; align-items:center;">
              <button id="btnSave" type="button">å„²å­˜æœ¬é¡çµæœ</button>
              <button id="btnClear" type="button">æ¸…ç©ºæœ¬é¡Œè¼¸å…¥</button>
            </div>
          </div>
    
          <div class="sectionCard" style="margin-top:12px; border-color:#eee;">
            <strong>è©•åˆ†ç¸½è¦½</strong>
            <div class="hint" id="progressText" style="margin-top:6px;">å°šæœªé–‹å§‹</div>
    
            <div class="grid2" style="margin-top:10px;">
              <div>
                <div class="label">ç¸½åˆ†ï¼ˆ5A+5Bï¼‰</div>
                <div id="totalScore" style="font-size:20px; font-weight:700;">-</div>
              </div>
            
              <div>
                <div class="label">å¹³å‡åˆ†ï¼ˆç¸½åˆ†/5ï¼‰</div>
                <div id="avgScore" style="font-size:20px; font-weight:700;">-</div>
              </div>
            
              <div>
                <div class="label">å®Œæˆåº¦</div>
                <div id="doneCount" style="font-size:20px; font-weight:700;">0/5</div>
              </div>
            </div>
    
            <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
              <button id="btnSubmit" type="button">ç¢ºèªé€å‡ºï¼ˆå®Œæˆå¾Œé–å®šï¼‰</button>
              <span class="hint">éœ€äº”é¡çš†å¡« A/B æ‰èƒ½é€å‡º</span>
            </div>
          </div>
    
          <div class="sectionCard">
            <div class="status" id="status"></div>
          </div>
          <!-- ===== ä¸Šé¢æ•´åŒ…ï¼šåŸæœ¬ scorePane å…§å®¹çµæŸ ===== -->
    
        </div>
      </div>
    
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
      import {
        getFirestore, doc, getDoc, updateDoc, serverTimestamp,
        addDoc, collection
      } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

      // ===== Firebase è¨­å®š =====
      const firebaseConfig = {
        apiKey: "AIzaSyBqSDWpIR_Bm2CVdnObkkuopOBrxgoXlH0",
        authDomain: "tcswg-ai-qa.firebaseapp.com",
        projectId: "tcswg-ai-qa"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // ===== ç‹€æ…‹ =====
      let EVAL_ID = null;
      let IS_LOCKED = false;
      let hasUnsavedOrUnsubmittedWork = false;
      let isSubmitted = false;

      // åˆ†é¡
      const CATEGORIES = ["åŒ–ç³æ± è™•ç†","æ”¿ç­–èˆ‡æ³•è¦","æ–½å·¥èˆ‡æŠ€è¡“","æ¥ç®¡æµç¨‹èˆ‡æœŸé™","è²»ç”¨èˆ‡è£œåŠ©"];
      const CATEGORY_KEYS = {
        "åŒ–ç³æ± è™•ç†": "septic",
        "æ¥ç®¡æµç¨‹èˆ‡æœŸé™": "connection",
        "æ–½å·¥èˆ‡æŠ€è¡“": "construction",
        "è²»ç”¨èˆ‡è£œåŠ©": "subsidy",
        "æ”¿ç­–èˆ‡æ³•è¦": "policy"
      };

      let QUESTIONS = {};
      let currentCategory = CATEGORIES[0];
      let currentQuestion = null;

      // ===== DOM =====
      const elCat = document.getElementById("category");
      const elList = document.getElementById("qList");
      const elA = document.getElementById("aText");
      const elALong = document.getElementById("aLongText");
      const elScoreA = document.getElementById("scoreA");
      const elScoreB = document.getElementById("scoreB");
      const elComment = document.getElementById("comment");
      const elCommentCount = document.getElementById("commentCount");
      const elStatus = document.getElementById("status");
      const elDept = document.getElementById("dept");
      const elTitle = document.getElementById("title");
      const elName = document.getElementById("name");
      const elBtnStart = document.getElementById("btnStart");
      const elProgressText = document.getElementById("progressText");
      const elTotalScore = document.getElementById("totalScore");
      const elDoneCount = document.getElementById("doneCount");
      const elAvgScore = document.getElementById("avgScore");
      const elBtnSubmit = document.getElementById("btnSubmit");
      const elStartStatus = document.getElementById("startStatus");
      const elScoreTitle = document.getElementById("scoreTitle");

      // ===== Authï¼šç¢ºä¿åŒ¿åç™»å…¥å®Œæˆ =====
      async function initAuth() {
        if (auth.currentUser) return;

        await signInAnonymously(auth);

        if (!auth.currentUser) {
          await new Promise((resolve) => {
            const unsub = onAuthStateChanged(auth, (u) => {
              if (u) { unsub(); resolve(); }
            });
          });
        }
      }

      function setStatus(msg, ok=true) {
        elStatus.innerHTML = ok
          ? `<span style="color:green;">âœ… ${msg}</span>`
          : `<span style="color:#b91c1c;">âŒ ${msg}</span>`;
      }

      function setStartStatus(msg, ok=true){
        elStartStatus.textContent = msg || "";
        elStartStatus.className = "miniStatus " + (ok ? "ok" : "bad");
      }

      function updateCommentCount() {
        const len = (elComment.value || "").length;
        elCommentCount.textContent = String(len);
      }

      function setScoringEnabled(enabled) {
        elCat.disabled = !enabled;
        document.getElementById("btnSave").disabled = !enabled;
        document.getElementById("btnClear").disabled = !enabled;
        elScoreA.disabled = !enabled;
        elScoreB.disabled = !enabled;
        elComment.disabled = !enabled;
      }

      function validateRaterInfo() {
        const dept = elDept.value.trim();
        const title = elTitle.value.trim();
        const name = elName.value.trim();
        if (!dept) return { ok:false, msg:"è«‹å…ˆé¸æ“‡ç§‘å®¤" };
        if (!title) return { ok:false, msg:"è«‹å…ˆå¡«å¯«è·ç¨±" };
        if (!name) return { ok:false, msg:"è«‹å…ˆå¡«å¯«å§“å" };
        return { ok:true, dept, title, name };
      }

      function validateScores() {
        const a = elScoreA.value === "" ? null : Number(elScoreA.value);
        const b = elScoreB.value === "" ? null : Number(elScoreB.value);
        if (a !== null && (Number.isNaN(a) || a < 0 || a > 50)) return { ok:false, msg:"A å¿…é ˆæ˜¯ 0~50" };
        if (b !== null && (Number.isNaN(b) || b < 0 || b > 50)) return { ok:false, msg:"B å¿…é ˆæ˜¯ 0~50" };
        return { ok:true, a, b };
      }

      function isCategoryComplete(catData) {
        if (!catData) return false;
        const a = catData.scoreA;
        const b = catData.scoreB;
        if (a === null || a === "" || typeof a === "undefined") return false;
        if (b === null || b === "" || typeof b === "undefined") return false;
        if (typeof a !== "number" || typeof b !== "number") return false;
        if (a < 0 || a > 50 || b < 0 || b > 50) return false;
        return true;
      }

      async function loadQuestions() {
        const res = await fetch("./questions.json");
        if (!res.ok) throw new Error("è®€å– questions.json å¤±æ•—");
        QUESTIONS = await res.json();
      }

      function renderCategoryOptionsPlain() {
        elCat.innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join("");
        elCat.value = currentCategory;
      }

      function renderCategoryOptionsWithMarks(cats) {
        elCat.innerHTML = CATEGORIES.map(cat => {
          const cd = cats[cat] || cats[CATEGORY_KEYS[cat]];
          const isDone = isCategoryComplete(cd);
          const mark = isDone ? " ğŸŸ¢" : " âšª";
          return `<option value="${cat}">${cat}${mark}</option>`;
        }).join("");
        elCat.value = currentCategory;
      }

      function renderQuestionList() {
        const qs = QUESTIONS[currentCategory] || [];
        elList.innerHTML = "";
        qs.forEach(q => {
          const div = document.createElement("div");
          div.className = "qitem" + (q.id === currentQuestion?.id ? " active" : "");
          div.style.cursor = IS_LOCKED ? "default" : "pointer";
          div.innerHTML = `<div><strong>${q.id}</strong></div><div style="margin-top:4px; white-space:pre-wrap;">${q.q}</div>`;
          div.onclick = () => {
            currentQuestion = q;
            renderQuestionList();
            renderQuestionContent();
            setStatus(IS_LOCKED ? "å·²é–å®šï¼ˆåƒ…å¯ç€è¦½ï¼‰" : "å·²åˆ‡æ›é¡Œç›®ï¼ˆå°šæœªå„²å­˜ï¼‰", true);
          };
          elList.appendChild(div);
        });
      }

      function renderQuestionContent() {
        elA.textContent = currentQuestion?.aShort || "";
        elALong.textContent = currentQuestion?.aLong || "";
      }

      function renderScoreTitle() {
        elScoreTitle.textContent = `ã€Œ${currentCategory}ã€è©•åˆ†`;
      }

      function clearInputs() {
        elScoreA.value = "";
        elScoreB.value = "";
        elComment.value = "";
        updateCommentCount();
      }

      async function loadCategoryInputs() {
        if (!EVAL_ID) return;
        await initAuth();

        elScoreA.value = "";
        elScoreB.value = "";
        elComment.value = "";
        updateCommentCount();

        try {
          const snap = await getDoc(doc(db, "scores", EVAL_ID));
          if (!snap.exists()) return;

          const data = snap.data();
          const catData = data?.categories?.[currentCategory] || data?.categories?.[CATEGORY_KEYS[currentCategory]];
          if (!catData) return;

          elScoreA.value = (catData.scoreA ?? "") === null ? "" : (catData.scoreA ?? "");
          elScoreB.value = (catData.scoreB ?? "") === null ? "" : (catData.scoreB ?? "");
          elComment.value = catData.comment ?? "";
          updateCommentCount();
        } catch (err) {
          console.error(err);
          setStatus("è®€å–æ—¢æœ‰åˆ†æ•¸å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰", false);
        }
      }

      async function refreshSummary() {
        if (!EVAL_ID) {
          elProgressText.textContent = "å°šæœªå»ºç«‹è©•åˆ†ç´€éŒ„";
          elTotalScore.textContent = "-";
          elDoneCount.textContent = "0/5";
          elAvgScore.textContent = "-";
          elBtnSubmit.disabled = true;
          renderCategoryOptionsPlain();
          return;
        }

        await initAuth();

        try {
          const snap = await getDoc(doc(db, "scores", EVAL_ID));
          if (!snap.exists()) return;

          const data = snap.data();
          const cats = data.categories || {};
          isSubmitted = (data.submitted === true);
          IS_LOCKED = isSubmitted;

          let done = 0;
          let total = 0;

          for (const cat of CATEGORIES) {
            const cd = cats[cat] || cats[CATEGORY_KEYS[cat]];
            if (isCategoryComplete(cd)) {
              done += 1;
              total += (cd.scoreA + cd.scoreB);
            }
          }

          elDoneCount.textContent = `${done}/5`;
          elTotalScore.textContent = done === 0 ? "-" : String(total);
          
          // âœ… å¹³å‡åˆ†ï¼šç¸½åˆ†/5ï¼ˆé¡¯ç¤ºåˆ°å°æ•¸ 1 ä½å¯é¸ï¼‰
          if (done === 0) {
            elAvgScore.textContent = "-";
          } else {
            const avg = total / 5;
            elAvgScore.textContent = String(Math.round(avg * 10) / 10); // ä¾‹å¦‚ 80 æˆ– 80.4
          }
          if (isSubmitted) {
            elProgressText.textContent = "âœ… å·²é€å‡ºï¼ˆå·²é–å®šï¼‰";
          } else {
            elProgressText.textContent = done === 5
              ? "âœ… äº”é¡çš†å®Œæˆï¼Œå¯ä»¥é€å‡º"
              : `å°šæœªå®Œæˆï¼šé‚„å·® ${5 - done} é¡`;
          }

          elBtnSubmit.disabled = (done !== 5) || isSubmitted;

          // âœ… é€™è£¡ç”¨ value ç¶­æŒæ­£ç¢ºåˆ†é¡ï¼Œæ–‡å­—æ‰åŠ  emoji
          renderCategoryOptionsWithMarks(cats);

        } catch (err) {
          console.error(err);
          setStatus("è®€å–ç¸½è¦½å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰", false);
        }
      }

      // ===== äº‹ä»¶ =====
      elCat.addEventListener("change", async () => {
        currentCategory = elCat.value;

        const qs = QUESTIONS[currentCategory] || [];
        currentQuestion = qs[0] || null;

        renderQuestionList();
        renderQuestionContent();
        renderScoreTitle();

        await loadCategoryInputs();
        await refreshSummary();

        setStatus(IS_LOCKED ? "å·²é–å®šï¼ˆåƒ…å¯ç€è¦½ï¼‰" : "å·²åˆ‡æ›åˆ†é¡ï¼ˆå·²è¼‰å…¥æœ¬åˆ†é¡åˆ†æ•¸/è©•èªï¼‰", true);
      });

      elComment.addEventListener("input", () => {
        if (elComment.value.length > 200) elComment.value = elComment.value.slice(0, 200);
        updateCommentCount();
      });

      document.getElementById("btnClear").addEventListener("click", () => {
        if (IS_LOCKED || isSubmitted) {
          setStatus("å·²é€å‡ºé–å®šï¼Œç„¡æ³•å†ä¿®æ”¹", false);
          return;
        }
        clearInputs();
        setStatus("å·²æ¸…ç©ºæœ¬æ¬¡è¼¸å…¥", true);
      });

      elBtnStart.addEventListener("click", async () => {
        if (IS_LOCKED || isSubmitted) {
          setStatus("æ­¤ä»½è©•åˆ†å·²é€å‡ºé–å®šã€‚è«‹é‡æ•´å¾Œé‡æ–°é–‹å§‹è©•åˆ†ã€‚", false);
          return;
        }

        const v = validateRaterInfo();
        if (!v.ok) { setStartStatus(v.msg, false); return; }
        setStartStatus("åŸºæœ¬è³‡æ–™ OK", true);

        try {
          await initAuth();
          const uid = auth.currentUser?.uid;
          if (!uid) throw new Error("Auth å°šæœªå°±ç·’ï¼Œæ²’æœ‰ uid");

          const docRef = await addDoc(collection(db, "scores"), {
            ownerUid: uid,         // âœ… rules éœ€è¦
            submitted: false,
            totalScore: 0,
            categories: {},
            rater: { dept: v.dept, title: v.title, name: v.name },
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });

          EVAL_ID = docRef.id;
          hasUnsavedOrUnsubmittedWork = true;
          isSubmitted = false;
          IS_LOCKED = false;

          setScoringEnabled(true);

          // åˆå§‹åŒ–é¡¯ç¤ºç¬¬ä¸€åˆ†é¡ç¬¬ä¸€é¡Œ
          currentCategory = CATEGORIES[0];
          currentQuestion = (QUESTIONS[currentCategory] && QUESTIONS[currentCategory][0]) ? QUESTIONS[currentCategory][0] : null;

          renderCategoryOptionsPlain();
          renderQuestionList();
          renderQuestionContent();
          renderScoreTitle();

          await refreshSummary();
          setStatus("å·²å»ºç«‹æ–°çš„è©•åˆ†ç´€éŒ„ï¼Œå¯ä»¥é–‹å§‹è©•åˆ†", true);
          setStartStatus("å¯ä»¥é–‹å§‹è©•åˆ†", true);

        } catch (err) {
          console.error(err);
          setStatus("å»ºç«‹è©•åˆ†ç´€éŒ„å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰", false);
        }
      });

      document.getElementById("btnSave").addEventListener("click", async () => {
        if (!EVAL_ID) { setStatus("è«‹å…ˆæŒ‰ã€Œé–‹å§‹è©•åˆ†ã€å»ºç«‹è©•åˆ†ç´€éŒ„", false); return; }
        if (IS_LOCKED || isSubmitted) { setStatus("å·²é€å‡ºé–å®šï¼Œç„¡æ³•å†ä¿®æ”¹", false); return; }

        const r = validateRaterInfo();
        if (!r.ok) { setStatus("è«‹å…ˆå®Œæˆç§‘å®¤/è·ç¨±/å§“åï¼ŒæŒ‰ã€Œé–‹å§‹è©•åˆ†ã€", false); return; }
        if (!currentQuestion) { setStatus("æ²’æœ‰é¸åˆ°é¡Œç›®", false); return; }

        const v = validateScores();
        if (!v.ok) { setStatus(v.msg, false); return; }

        const comment = (elComment.value || "").trim();
        if (comment.length > 200) { setStatus("è©•èªæœ€å¤š 200 å­—", false); return; }

        try {
          await initAuth();

          await updateDoc(doc(db, "scores", EVAL_ID), {
            updatedAt: serverTimestamp(),
            [`categories.${currentCategory}`]: {
              scoreA: v.a,
              scoreB: v.b,
              comment,
              updatedAt: serverTimestamp()
            }
          });

          hasUnsavedOrUnsubmittedWork = true;
          await refreshSummary();
          setStatus("å·²å„²å­˜æœ¬é¡è©•åˆ†", true);

        } catch (err) {
          console.error(err);
          setStatus("å¯«å…¥å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰", false);
        }
      });

      // ===== é€å‡º =====
      elBtnSubmit.addEventListener("click", async () => {
        if (!EVAL_ID) { setStatus("è«‹å…ˆæŒ‰ã€Œé–‹å§‹è©•åˆ†ã€å»ºç«‹è©•åˆ†ç´€éŒ„", false); return; }
        if (isSubmitted || IS_LOCKED) { setStatus("å·²é€å‡ºï¼ˆå·²é–å®šï¼‰", true); return; }

        await refreshSummary();
        if (elBtnSubmit.disabled) { setStatus("éœ€äº”é¡çš†å¡« A/B æ‰èƒ½é€å‡º", false); return; }

        if (!confirm("ç¢ºèªé€å‡ºå¾Œå°‡é–å®šï¼Œç„¡æ³•å†ä¿®æ”¹ã€‚ç¢ºå®šé€å‡ºï¼Ÿ")) return;

        try {
          await initAuth();

          const snap = await getDoc(doc(db, "scores", EVAL_ID));
          if (!snap.exists()) { setStatus("æ‰¾ä¸åˆ°è©•åˆ†ç´€éŒ„ï¼Œç„¡æ³•é€å‡º", false); return; }

          const data = snap.data();
          const cats = data.categories || {};

          let total = 0;
          for (const cat of CATEGORIES) {
            const cd = cats[cat] || cats[CATEGORY_KEYS[cat]];
            if (!isCategoryComplete(cd)) {
              setStatus(`ã€Œ${cat}ã€å°šæœªå®Œæˆï¼Œè«‹å…ˆå¡« A/B`, false);
              return;
            }
            total += (cd.scoreA + cd.scoreB);
          }

          const avg = total / 5;   // â­ æ–°å¢ï¼šè¨ˆç®—å¹³å‡åˆ†

          await updateDoc(doc(db, "scores", EVAL_ID), {
            submitted: true,
            submittedAt: serverTimestamp(),
            totalScore: total,
            avgScore: avg,         // â­ æ–°å¢ï¼šå¯«å…¥è³‡æ–™åº«
            updatedAt: serverTimestamp()
          });

          IS_LOCKED = true;
          isSubmitted = true;
          setScoringEnabled(false);
          elBtnSubmit.disabled = true;

          await refreshSummary();
          setStatus("âœ… å·²é€å‡ºä¸¦é–å®šå®Œæˆï¼Œæ„Ÿè¬è©•åˆ†ï¼Œå¦‚éœ€é‡æ–°è©•åˆ†è«‹é‡æ•´ç¶²é å†é–‹å§‹ï¼", true);

        } catch (err) {
          console.error(err);
          setStatus("é€å‡ºå¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰", false);
        }
      });

      // ===== åˆå§‹åŒ– =====
      (async function boot() {
        setScoringEnabled(false); // ä¸€é–‹å§‹é–
        try { await initAuth(); } catch(e) { console.error(e); } // å…ˆæŠŠåŒ¿åç™»å…¥æº–å‚™å¥½

        try {
          await loadQuestions();
          currentCategory = CATEGORIES[0];
          currentQuestion = (QUESTIONS[currentCategory] && QUESTIONS[currentCategory][0]) ? QUESTIONS[currentCategory][0] : null;

          renderCategoryOptionsPlain();
          renderQuestionList();
          renderQuestionContent();
          renderScoreTitle();

          setStatus("é¡Œåº«å·²è¼‰å…¥ã€‚è«‹å…ˆå¡«ç§‘å®¤/è·ç¨±/å§“åï¼ŒæŒ‰ã€Œé–‹å§‹è©•åˆ†ã€å¾Œå†è©•åˆ†", true);
        } catch (err) {
          console.error(err);
          setStatus("é¡Œåº«è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª questions.json è·¯å¾‘èˆ‡æ˜¯å¦æœ‰ä¸Šå‚³åˆ° GitHub", false);
        }
      })();

      // é›¢é–‹æé†’
      window.addEventListener("beforeunload", (e) => {
        if (!EVAL_ID) return;
        if (isSubmitted) return;
        if (!hasUnsavedOrUnsubmittedWork) return;
        e.preventDefault();
        e.returnValue = "";
      });
    </script>

  </div>
</body>
</html>
