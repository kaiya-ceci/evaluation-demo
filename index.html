<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>外部評分骨架</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif; margin: 16px; }
    .row { display: flex; gap: 16px; align-items: flex-start; }
    .col { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
    .left { width: 45%; min-width: 320px; }
    .right { width: 55%; min-width: 360px; }
    select, input, textarea, button { font-size: 14px; padding: 8px; }
    textarea { width: 100%; min-height: 90px; }
    .qitem { padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; cursor: pointer; }
    .qitem:hover { background: #fafafa; }
    .qitem.active { border-color: #4f46e5; background: #eef2ff; }
    .label { font-size: 12px; color: #555; margin-top: 10px; margin-bottom: 4px; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .hint { color: #666; font-size: 12px; margin-top: 8px; }
    .status { margin-top: 10px; }
  </style>
</head>
<body>

<h2>外部評分（互動骨架版）</h2>

<h3 style="margin-top:10px;">評分者基本資料</h3>

<div class="grid2" style="margin-top: 8px;">
  <div>
    <div class="label">科室（必選）</div>
    <select id="dept" style="width:100%;">
      <option value="">請選擇</option>
      <option value="高階主管">高階主管</option>
      <option value="污水工程科">污水工程科</option>
      <option value="污水設施科">污水設施科</option>
      <option value="污水營運科">污水營運科</option>
    </select>
  </div>
  <div>
    <div class="label">職稱（必填）</div>
    <input id="title" type="text" placeholder="例如：工程司" style="width:100%;" />
  </div>
</div>

<div style="margin-top: 10px;">
  <div class="label">姓名（必填）</div>
  <input id="name" type="text" placeholder="例如：王小明" style="width:100%;" />
</div>

<div style="margin-top: 12px; display:flex; gap:10px; align-items:center;">
  <button id="btnStart" type="button">開始評分</button>
  <span class="hint">三項填完才可開始</span>
</div>

<hr style="margin: 14px 0; border:0; border-top:1px solid #eee;" />

<div class="label">分類</div>
<select id="category"></select>


<div class="row" style="margin-top: 12px;">
  <div class="col left">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <strong>題目清單</strong>
      <span class="hint">先用假資料</span>
    </div>
    <div id="qList" style="margin-top: 10px;"></div>
  </div>

  <div class="col right">
    <strong>題目內容</strong>

    <div class="label">題目</div>
    <div id="qText" style="white-space: pre-wrap; border:1px solid #eee; border-radius:8px; padding:10px; min-height:60px;"></div>

    <div class="label">答案（供評分者參考）</div>
    <div id="aText" style="white-space: pre-wrap; border:1px solid #eee; border-radius:8px; padding:10px; min-height:60px;"></div>

    <div class="grid2">
      <div>
        <div class="label">內容正確性 A（0~50）</div>
        <input id="scoreA" type="number" min="0" max="50" step="1" placeholder="0~50" style="width:100%;" />
      </div>
      <div>
        <div class="label">語意完整性 B（0~50）</div>
        <input id="scoreB" type="number" min="0" max="50" step="1" placeholder="0~50" style="width:100%;" />
      </div>
    </div>

    <div class="label">本類評語（可空白）</div>
    <textarea id="comment" placeholder="可留空"></textarea>

    <div style="margin-top: 12px; display:flex; gap:10px; align-items:center;">
      <button id="btnSave">儲存本類結果</button>
      <button id="btnClear" type="button">清空本題輸入</button>
    </div>

    <div class="status" id="status"></div>
    <div class="hint">目前儲存是「每按一次就新增一筆」：只是先驗證互動與寫入。下一步再改成「同一人同一筆更新」。</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";


  // ✅ 你的 Firebase 設定
  const firebaseConfig = {
    apiKey: "AIzaSyBqSDWpIR_Bm2CVdnObkkuopOBrxgoXlH0",
    authDomain: "tcswg-ai-qa.firebaseapp.com",
    projectId: "tcswg-ai-qa"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const EVAL_ID = "demo-eval-001"; // 先寫死：之後再換成真的同一人/同一場次 id


  // ✅ 分類（這一定要是「陣列」）
  const CATEGORIES = [
    "化糞池處理",
    "接管流程與期限",
    "施工與技術",
    "費用與補助",
    "政策與法規"
  ];
  
  // ✅ 分類代碼（這是物件，不是陣列）
  const CATEGORY_KEYS = {
    "化糞池處理": "septic",
    "接管流程與期限": "connection",
    "施工與技術": "construction",
    "費用與補助": "subsidy",
    "政策與法規": "policy"
  };

  let QUESTIONS = {};

  async function loadQuestions() {
    const res = await fetch("./questions.json");
    if (!res.ok) throw new Error("讀取 questions.json 失敗");
    QUESTIONS = await res.json();
  }


  // --- UI 狀態 ---
  let currentCategory = CATEGORIES[0];
  let currentQuestion = null;  // ✅ 先不要碰 QUESTIONS


  const elCat = document.getElementById("category");
  const elList = document.getElementById("qList");
  const elQ = document.getElementById("qText");
  const elA = document.getElementById("aText");
  const elScoreA = document.getElementById("scoreA");
  const elScoreB = document.getElementById("scoreB");
  const elComment = document.getElementById("comment");
  const elStatus = document.getElementById("status");
  const elDept = document.getElementById("dept");
  const elTitle = document.getElementById("title");
  const elName = document.getElementById("name");
  const elBtnStart = document.getElementById("btnStart");

  function setScoringEnabled(enabled) {
    elCat.disabled = !enabled;
    document.getElementById("btnSave").disabled = !enabled;
    document.getElementById("btnClear").disabled = !enabled;
    elScoreA.disabled = !enabled;
    elScoreB.disabled = !enabled;
    elComment.disabled = !enabled;
  }
  
  function validateRaterInfo() {
    const dept = elDept.value.trim();
    const title = elTitle.value.trim();
    const name = elName.value.trim();
  
    if (!dept) return { ok:false, msg:"請先選擇科室" };
    if (!title) return { ok:false, msg:"請先填寫職稱" };
    if (!name) return { ok:false, msg:"請先填寫姓名" };
  
    return { ok:true, dept, title, name };
  }



  async function loadCategoryInputs() {
    // 預設清空
    elScoreA.value = "";
    elScoreB.value = "";
    elComment.value = "";
  
    try {
      const snap = await getDoc(doc(db, "scores", EVAL_ID));
      if (!snap.exists()) return;
  
      const data = snap.data();
      console.log("currentCategory =", currentCategory);
      console.log("categories keys =", Object.keys(data?.categories || {}), data?.categories);
      const catData = 
        data?.categories?.[currentCategory] ||
        data?.categories?.[CATEGORY_KEYS[currentCategory]];
      
      if (!catData) {
        console.log("❗找不到這個分類的資料");
        return;
      }
  
      // 帶回既有資料
      elScoreA.value = (catData.scoreA ?? "") === null ? "" : (catData.scoreA ?? "");
      elScoreB.value = (catData.scoreB ?? "") === null ? "" : (catData.scoreB ?? "");
      elComment.value = catData.comment ?? "";
    } catch (err) {
      console.error(err);
      setStatus("讀取既有分數失敗（請看 Console）", false);
    }
  }

    
  function setStatus(msg, ok=true) {
    elStatus.innerHTML = ok ? `<span style="color:green;">✅ ${msg}</span>` : `<span style="color:#b91c1c;">❌ ${msg}</span>`;
  }

  function renderCategoryOptions() {
    elCat.innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join("");
    elCat.value = currentCategory;
  }

  function renderQuestionList() {
    const qs = QUESTIONS[currentCategory] || [];
    elList.innerHTML = "";
    qs.forEach(q => {
      const div = document.createElement("div");
      div.className = "qitem" + (q.id === currentQuestion?.id ? " active" : "");
      div.innerHTML = `<div><strong>${q.id}</strong></div><div style="margin-top:4px; white-space:pre-wrap;">${q.q}</div>`;
      div.onclick = () => {
        currentQuestion = q;
        renderQuestionList();
        renderQuestionContent();
        setStatus("已切換題目（尚未儲存）", true);
      };
      elList.appendChild(div);
    });
  }

  function renderQuestionContent() {
    elQ.textContent = currentQuestion?.q || "";
    elA.textContent = currentQuestion?.aShort || "";
  }

  function clearInputs() {
    elScoreA.value = "";
    elScoreB.value = "";
    elComment.value = "";
  }

  function validateScores() {
    // 允許空白先不管，互動骨架先跑通；下一步再加嚴格規則
    const a = elScoreA.value === "" ? null : Number(elScoreA.value);
    const b = elScoreB.value === "" ? null : Number(elScoreB.value);

    if (a !== null && (Number.isNaN(a) || a < 0 || a > 50)) return { ok:false, msg:"A 必須是 0~50" };
    if (b !== null && (Number.isNaN(b) || b < 0 || b > 50)) return { ok:false, msg:"B 必須是 0~50" };
    return { ok:true, a, b };
  }

  // --- 事件 ---
  elCat.addEventListener("change", async () => {
    currentCategory = elCat.value;
    currentQuestion = QUESTIONS[currentCategory][0];
    renderQuestionList();
    renderQuestionContent();
  
    await loadCategoryInputs(); // ✅ 改成載入本分類已存的分數/評語
    setStatus("已切換分類（已載入本分類分數/評語）", true);
  });

  document.getElementById("btnClear").addEventListener("click", () => {
    clearInputs();
    setStatus("已清空本題輸入", true);
  });
  elBtnStart.addEventListener("click", async () => {
    const v = validateRaterInfo();
    if (!v.ok) {
      setStatus(v.msg, false);
      return;
    }
  
    try {
      await setDoc(doc(db, "scores", EVAL_ID), {
        evalId: EVAL_ID,
        rater: {
          dept: v.dept,
          title: v.title,
          name: v.name
        },
        raterReady: true,
        updatedAt: serverTimestamp()
      }, { merge: true });
  
      setScoringEnabled(true);
      setStatus("已確認基本資料，可以開始評分", true);
    } catch (err) {
      console.error(err);
      setStatus("寫入基本資料失敗，請看 Console", false);
    }
  });


  document.getElementById("btnSave").addEventListener("click", async () => {
        const r = validateRaterInfo();
        if (!r.ok) { setStatus("請先完成科室/職稱/姓名，按「開始評分」", false); return; }
    
        if (!currentQuestion) {
          setStatus("沒有選到題目", false);
          return;
        }
        const v = validateScores();
        if (!v.ok) {
          setStatus(v.msg, false);
          return;
        }

    try {
         
      await updateDoc(doc(db, "scores", EVAL_ID), {
        updatedAt: serverTimestamp(),
        [`categories.${currentCategory}`]: {
          scoreA: v.a,
          scoreB: v.b,
          comment: elComment.value || "",
          updatedAt: serverTimestamp()
        }
      });

      


      setStatus("已儲存（已寫入 Firestore）", true);
    } catch (err) {
      console.error(err);
      setStatus("寫入失敗，請看 Console", false);
    }
  });

  // --- 初始化 ---
  setScoringEnabled(false);  // ✅ 一進來先鎖
  
  try {
    await loadQuestions(); // ✅ 先把 200 題載進來
    console.log("題庫分類 keys =", Object.keys(QUESTIONS));
  
    // ✅ 讓分類下拉用「你既有的 CATEGORIES 順序」，而不是 Object.keys 的隨機順序
    currentCategory = CATEGORIES[0];
    currentQuestion = (QUESTIONS[currentCategory] && QUESTIONS[currentCategory][0]) ? QUESTIONS[currentCategory][0] : null;
  
    renderCategoryOptions();
    renderQuestionList();
    renderQuestionContent();
  
    // ❌ 初始化時先不要 loadCategoryInputs（因為還沒按開始評分）
    setStatus("題庫已載入。請先填科室/職稱/姓名，按「開始評分」後再評分", true);
  } catch (err) {
    console.error(err);
    setStatus("題庫載入失敗：請確認 questions.json 路徑與是否有上傳到 GitHub", false);
  }


  

</script>
</body>
</html>
