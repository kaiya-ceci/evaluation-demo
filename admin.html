<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>è©•åˆ†ç®¡ç†ç«¯</title>
<style>
  body { font-family: system-ui; margin:20px; }
  table { border-collapse: collapse; width:100%; margin-top:15px; }
  th, td { border:1px solid #ddd; padding:8px; font-size:14px; }
  th { background:#f3f4f6; }
  button { padding:8px 14px; font-size:14px; }
</style>
</head>
<body>

<h2>è©•åˆ†ç®¡ç†ç«¯</h2>

<button id="btnExport">ä¸‹è¼‰ CSV</button>

<table id="dataTable">
  <thead>
    <tr>
      <th>å§“å</th>
      <th>ç§‘å®¤</th>
      <th>è·ç¨±</th>
      <th>åŒ–ç³æ± è™•ç†</th>
      <th>æ”¿ç­–èˆ‡æ³•è¦</th>
      <th>æ–½å·¥èˆ‡æŠ€è¡“</th>
      <th>æ¥ç®¡æµç¨‹èˆ‡æœŸé™</th>
      <th>è²»ç”¨èˆ‡è£œåŠ©</th>
      <th>åŒ–ç³æ± è™•ç†è©•èª</th>
      <th>æ”¿ç­–èˆ‡æ³•è¦è©•èª</th>
      <th>æ–½å·¥èˆ‡æŠ€è¡“è©•èª</th>
      <th>æ¥ç®¡æµç¨‹èˆ‡æœŸé™è©•èª</th>
      <th>è²»ç”¨èˆ‡è£œåŠ©è©•èª</th>
      <th>ç¸½åˆ†</th>
      <th>é€å‡ºæ™‚é–“</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
import { initializeApp } 
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import { 
  getFirestore, collection, getDocs 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBqSDWpIR_Bm2CVdnObkkuopOBrxgoXlH0",
  authDomain: "tcswg-ai-qa.firebaseapp.com",
  projectId: "tcswg-ai-qa"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const CATEGORIES = [
  "åŒ–ç³æ± è™•ç†",
  "æ”¿ç­–èˆ‡æ³•è¦",
  "æ–½å·¥èˆ‡æŠ€è¡“",
  "æ¥ç®¡æµç¨‹èˆ‡æœŸé™",
  "è²»ç”¨èˆ‡è£œåŠ©"
];

const tableBody = document.querySelector("#dataTable tbody");
const btnExport = document.getElementById("btnExport");

let exportRows = [];

async function loadData() {
  const snap = await getDocs(collection(db, "scores"));

  tableBody.innerHTML = "";
  exportRows = [];

  snap.forEach(docSnap => {
    const data = docSnap.data();
    if (!data.submitted) return; // ğŸ”¥ åªæŠ“å·²é€å‡º

    const r = data.rater || {};
    const cats = data.categories || {};

    const row = {
      name: r.name || "",
      dept: r.dept || "",
      title: r.title || "",
      total: data.totalScore || 0,
      time: data.submittedAt?.toDate?.().toLocaleString() || ""
    };

    CATEGORIES.forEach(cat => {
      const cd = cats[cat];
      row[cat] = cd ? (cd.scoreA + cd.scoreB) : "";
      row[cat + "_comment"] = cd?.comment ?? "";
    });

    exportRows.push(row);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.name}</td>
      <td>${row.dept}</td>
      <td>${row.title}</td>
      <td>${row["åŒ–ç³æ± è™•ç†"]}</td>
      <td>${row["æ”¿ç­–èˆ‡æ³•è¦"]}</td>
      <td>${row["æ–½å·¥èˆ‡æŠ€è¡“"]}</td>
      <td>${row["æ¥ç®¡æµç¨‹èˆ‡æœŸé™"]}</td>
      <td>${row["è²»ç”¨èˆ‡è£œåŠ©"]}</td>
      <td style="white-space:pre-wrap;">${row["åŒ–ç³æ± è™•ç†_comment"]}</td>
      <td style="white-space:pre-wrap;">${row["æ”¿ç­–èˆ‡æ³•è¦_comment"]}</td>
      <td style="white-space:pre-wrap;">${row["æ–½å·¥èˆ‡æŠ€è¡“_comment"]}</td>
      <td style="white-space:pre-wrap;">${row["æ¥ç®¡æµç¨‹èˆ‡æœŸé™_comment"]}</td>
      <td style="white-space:pre-wrap;">${row["è²»ç”¨èˆ‡è£œåŠ©_comment"]}</td>
      
      <td>${row.total}</td>
      <td>${row.time}</td>
    `;
    tableBody.appendChild(tr);
  });
}

btnExport.addEventListener("click", () => {
  if (exportRows.length === 0) {
    alert("æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™");
    return;
  }

  const headers = [
    "å§“å","ç§‘å®¤","è·ç¨±",
    "åŒ–ç³æ± è™•ç†","æ”¿ç­–èˆ‡æ³•è¦","æ–½å·¥èˆ‡æŠ€è¡“","æ¥ç®¡æµç¨‹èˆ‡æœŸé™","è²»ç”¨èˆ‡è£œåŠ©",
    "åŒ–ç³æ± è™•ç†è©•èª","æ”¿ç­–èˆ‡æ³•è¦è©•èª","æ–½å·¥èˆ‡æŠ€è¡“è©•èª","æ¥ç®¡æµç¨‹èˆ‡æœŸé™è©•èª","è²»ç”¨èˆ‡è£œåŠ©è©•èª",
    "ç¸½åˆ†","é€å‡ºæ™‚é–“"
  ];

  const rows = exportRows.map(r => [
    r.name,
    r.dept,
    r.title,
    r["åŒ–ç³æ± è™•ç†"],
    r["æ”¿ç­–èˆ‡æ³•è¦"],
    r["æ–½å·¥èˆ‡æŠ€è¡“"],
    r["æ¥ç®¡æµç¨‹èˆ‡æœŸé™"],
    r["è²»ç”¨èˆ‡è£œåŠ©"],

    r["åŒ–ç³æ± è™•ç†_comment"],
    r["æ”¿ç­–èˆ‡æ³•è¦_comment"],
    r["æ–½å·¥èˆ‡æŠ€è¡“_comment"],
    r["æ¥ç®¡æµç¨‹èˆ‡æœŸé™_comment"],
    r["è²»ç”¨èˆ‡è£œåŠ©_comment"],

    r.total,
    r.time
  ]);

  // âœ… é€ƒé€¸ï¼šé¿å…è©•èªå…§æœ‰å¼•è™Ÿ/æ›è¡ŒæŠŠ CSV å¼„å£
  const escapeCsv = (v) => {
    const s = String(v ?? "");
    return `"${s.replace(/"/g, '""')}"`;
  };

  const csvBody =
    [headers, ...rows]
      .map(line => line.map(escapeCsv).join(","))
      .join("\n");

  // âœ… Excel äº‚ç¢¼è§£æ³•ï¼šUTF-8 BOM
  const csvWithBom = "\uFEFF" + csvBody;

  const blob = new Blob([csvWithBom], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "è©•åˆ†åŒ¯å‡º.csv";
  a.click();
});

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "è©•åˆ†åŒ¯å‡º.csv";
  a.click();
});

loadData();
</script>

</body>
</html>
