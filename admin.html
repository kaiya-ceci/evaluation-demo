<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>è‡ºä¸­å¸‚æ°´åˆ©å±€AIå°å¹«æ‰‹æ¸¬è©¦-è©•åˆ†çµæœç€è¦½</title>
<style>
  body { font-family: system-ui; margin:20px; }

  /* å¤–å±¤æ°´å¹³æ²å‹• */
  .tableWrap{
    overflow:auto;
    border:1px solid #e5e7eb;
    border-radius:10px;
    margin-top:15px;
    max-height: 70vh; /* è®“ä½ å¯ä»¥å‚ç›´æ²å‹• */
  }

  table { border-collapse: collapse; width: 100%; table-layout: fixed; }
  th, td { border:1px solid #ddd; padding:8px; font-size:14px; vertical-align: top; }
  th { background:#f3f4f6; position: sticky; top: 0; z-index: 2; }

  button { padding:8px 14px; font-size:14px; }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { background: #e5e7eb; }

  /* åˆ†é¡åŒè‰²ï¼ˆæ·¡åº•ï¼‰ */
  .cat-septic  { background: #fff7ed; }
  .cat-policy  { background: #f0f9ff; }
  .cat-const   { background: #f5f3ff; }
  .cat-conn    { background: #f0fdf4; }
  .cat-subsidy { background: #fff1f2; }

  /* ç¸½åˆ†/æ™‚é–“ */
  .cat-total   { background: #f9fafb; }

  /* è©•èªæ›è¡Œ */
  .prewrap { white-space: pre-wrap; }

  /* å›ºå®šå·¦ä¸‰æ¬„ï¼ˆå¯é¸ï¼Œæƒ³è¦å°±ç•™ï¼‰ */
  th.stickyL, td.stickyL {
    position: sticky;
    left: 0;
    z-index: 3;
    background: #f3f4f6;
  }
  /* âœ… sticky ä½ç§»ç”¨æ¬„å¯¬ç®—ï¼Œæ°¸é ä¸æœƒè·‘æ‰ */
  th.stickyL2, td.stickyL2 { left: var(--w-name); }
  th.stickyL3, td.stickyL3 { left: calc(var(--w-name) + var(--w-dept)); }

  /* âœ… å·¦ä¸‰æ¬„å›ºå®šå¯¬åº¦ï¼ˆtable-layout: fixed æ™‚è¦ç”¨ width æ‰æº–ï¼‰ */
  :root{
    --w-name: 90px;
    --w-dept: 130px;
    --w-title: 120px;
  }
  
  .w-name  { width: var(--w-name);  min-width: var(--w-name);  max-width: var(--w-name); }
  .w-dept  { width: var(--w-dept);  min-width: var(--w-dept);  max-width: var(--w-dept); }
  .w-title { width: var(--w-title); min-width: var(--w-title); max-width: var(--w-title); }

  /* =========================
     âœ… Admin è¡¨æ ¼ç©©å®šç‰ˆ
     ========================= */
  
  /* è¡¨æ ¼å›ºå®šä½ˆå±€ï¼ˆé—œéµï¼‰ */
  table {
    width: 100%;
    table-layout: fixed;   /* â­ è®“æ¬„å¯¬å›ºå®š */
    border-collapse: collapse;
  }
  
  /* æ‰€æœ‰å„²å­˜æ ¼çµ±ä¸€è™•ç† */
  th, td {
    padding: 8px 10px;
    border: 1px solid #e5e7eb;
    vertical-align: top;
    word-break: break-word;      /* â­ é•·å­—ä¸²å¼·åˆ¶æ›è¡Œ */
    overflow-wrap: anywhere;     /* â­ ä»»ä½•åœ°æ–¹éƒ½èƒ½æ–·è¡Œ */
    white-space: normal;         /* â­ å…è¨±è‡ªå‹•æ›è¡Œ */
  }
  
  /* =========================
     æŒ‡å®šæ¬„å¯¬ï¼ˆå¯ä¾éœ€æ±‚å¾®èª¿ï¼‰
     ========================= */
  
  
  /* è¡¨æ ¼å¤–å±¤å¯æ©«å‘æ»‘å‹•ï¼ˆæ‰‹æ©Ÿç”¨ï¼‰ */
  .tableWrapper {
    overflow-x: auto;
  }
  /* âœ… è©•èªæ¬„çµ±ä¸€å¯¬åº¦ + å…§å®¹é¡¯ç¤º */
  th.commentCol, td.commentCol{
    width: 320px;
    min-width: 320px;
    max-width: 320px;
  }
  
  /* âœ… è®“æ¯æ ¼è©•èªä¸æŠŠæ•´åˆ—æ’çˆ†ï¼šå›ºå®šé«˜åº¦ + å…§éƒ¨æ²å‹• */
  td.commentCol{
    white-space: pre-wrap;      /* ä½ åŸæœ¬ prewrap ä¹Ÿå¯ä»¥ä¿ç•™ï¼Œé€™æ›´ç›´æ¥ */
    word-break: break-word;
    overflow-wrap: anywhere;
  
    height: 70px;              /* æ¯æ ¼ä¸€æ¨£é«˜ï¼ˆä½ å¯æ”¹ 120/160ï¼‰ */
    overflow-y: auto;
  }
  
  /* âœ… æ•¸å­—æ¬„ï¼ˆA/B/A+Bï¼‰å¯ä»¥çª„ä¸€é»ï¼Œè¡¨æ ¼æ›´æ•´é½Š */
  th.numCol, td.numCol{
    width: 110px;
    min-width: 110px;
    max-width: 110px;
    text-align: left;
  }
  /* å·¦ä¸‰æ¬„ï¼šè³‡æ–™æ ¼ç”¨çœç•¥è™Ÿï¼Œé¿å…æŠŠæ•´æ¬„æ’é«˜æˆ–ç›´æ’ */
  td.stickyL{
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* è¡¨é ­å¯ä»¥æ›è¡Œï¼Œé¿å…æ“ çˆ† */
  th{
    white-space: normal;
    line-height: 1.2;
  }
  /* ç¸½åˆ†/é€å‡ºæ™‚é–“æ¬„å›ºå®šå¯¬ï¼Œé¿å…è®Šæˆç›´æ’ */
  th.totalCol, td.totalCol{
    width: 90px;
    min-width: 90px;
    max-width: 90px;
    white-space: nowrap;
  }
  
  th.timeCol, td.timeCol{
    width: 170px;            /* ä½ å¯æ”¹ 190/210 */
    min-width: 170px;
    max-width: 170px;
    white-space: nowrap;     /* ä¸è¦ä¸€å­—ä¸€è¡Œ */
  }
  .infoBox{
    margin-top: 12px;
    margin-bottom: 10px;
    padding: 14px 16px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-left: 4px solid #2563eb;   /* å·¦å´è—è‰²å¼·èª¿ç·š */
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
  }
  
  .infoBox ul{
    margin: 8px 0 0 18px;
    padding: 0;
  }
  
  .infoBox li{
    margin-bottom: 4px;
  }
</style>
</head>
<body>

<h2>è‡ºä¸­å¸‚æ°´åˆ©å±€AIå°å¹«æ‰‹æ¸¬è©¦-è©•åˆ†çµæœç€è¦½</h2>

<div id="loginBox" style="margin:12px 0; padding:12px; border:1px solid #ddd; border-radius:8px; max-width:420px;">
  <div style="display:flex; gap:8px; margin-bottom:8px;">
    <input id="email" placeholder="Admin Email" style="flex:1; padding:8px;">
    <input id="password" placeholder="Password" type="password" style="flex:1; padding:8px;">
  </div>
  <button id="btnLogin">ç™»å…¥</button>
  <button id="btnLogout" style="display:none;">ç™»å‡º</button>
  <span id="loginMsg" style="margin-left:8px; color:#666;"></span>
</div>

<button id="btnExport" disabled>ä¸‹è¼‰ CSV</button>
<button id="btnToggleAB" disabled>å±•é–‹ A/B</button>
<div class="infoBox">
  <strong>ğŸ“Œ ä½¿ç”¨èªªæ˜</strong>
  <ul>
    <li>æœ¬é åƒ…é¡¯ç¤ºã€Œå·²å®Œæ•´è©•åˆ†ä¸¦é€å‡ºã€ä¹‹è©•åˆ†è³‡æ–™ã€‚</li>
    <li>å¯é»æ“Šæ¬„ä½æ¨™é¡Œé€²è¡Œæ’åºï¼ˆâ†‘â†“ï¼‰ã€‚</li>
    <li>ã€Œå±•é–‹ A/Bã€å¯æŸ¥çœ‹å„é¡Œ å…§å®¹æ­£ç¢ºæ€§Aã€èªæ„å®Œæ•´æ€§B åˆ†æ•¸æ˜ç´°ã€‚</li>
    <li>è©•èªæ¬„å›ºå®šé«˜åº¦ï¼Œå…§å®¹éé•·å¯æ–¼æ¬„å…§æ²å‹•ã€‚</li>
    <li>å¯ä½¿ç”¨ã€Œä¸‹è¼‰ CSVã€åŒ¯å‡ºå®Œæ•´è³‡æ–™ã€‚</li>
  </ul>
</div>

<div class="tableWrap">
  <table id="dataTable">
    <thead>
      <tr id="headerRow"></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged,
  setPersistence, inMemoryPersistence
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import { initializeApp }
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import {
  getFirestore, collection, getDocs
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/** ========= Firebase init ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBqSDWpIR_Bm2CVdnObkkuopOBrxgoXlH0",
  authDomain: "tcswg-ai-qa.firebaseapp.com",
  projectId: "tcswg-ai-qa"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/** âœ… é‡é»ï¼šåˆ·æ–°å°±è¦é‡æ–°ç™»å…¥ â†’ ç”¨ inMemoryPersistence */
await setPersistence(auth, inMemoryPersistence);

/** ========= DOM ========= */
const tableBody = document.querySelector("#dataTable tbody");
const headerRow = document.getElementById("headerRow");

const btnExport = document.getElementById("btnExport");
const btnToggleAB = document.getElementById("btnToggleAB");

const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const loginMsg = document.getElementById("loginMsg");

/** ========= Categories meta ========= */
const CAT_META = [
  { name:"åŒ–ç³æ± è™•ç†", cls:"cat-septic"  },
  { name:"æ”¿ç­–èˆ‡æ³•è¦", cls:"cat-policy"  },
  { name:"æ–½å·¥èˆ‡æŠ€è¡“", cls:"cat-const"   },
  { name:"æ¥ç®¡æµç¨‹èˆ‡æœŸé™", cls:"cat-conn" },
  { name:"è²»ç”¨èˆ‡è£œåŠ©", cls:"cat-subsidy" }
];

let exportRows = [];
let sortKey = null;
let sortAsc = true;
let showAB = false;

/** ========= Auth UI ========= */
btnLogin.addEventListener("click", async () => {
  loginMsg.textContent = "ç™»å…¥ä¸­â€¦";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (e) {
    console.error(e);
    loginMsg.textContent = "ç™»å…¥å¤±æ•—ï¼ˆå¸³å¯†éŒ¯èª¤æˆ–æœªé–‹å•Ÿ Email/Passwordï¼‰";
  }
});

btnLogout.addEventListener("click", async () => {
  await signOut(auth);
});

onAuthStateChanged(auth, async (user) => {
  if (!user || user.isAnonymous || !user.email) {
    loginMsg.textContent = "å°šæœªç™»å…¥";
    btnLogin.style.display = "";
    btnLogout.style.display = "none";
    btnExport.disabled = true;
    btnToggleAB.disabled = true;

    exportRows = [];
    tableBody.innerHTML = "";
    renderHeader();
    return;
  }

  loginMsg.textContent = `å·²ç™»å…¥ï¼š${user.email}`;
  btnLogin.style.display = "none";
  btnLogout.style.display = "";
  btnExport.disabled = false;
  btnToggleAB.disabled = false;

  renderHeader();
  await loadData();
});

/** ========= Load ========= */
async function loadData() {
  try {
    const snap = await getDocs(collection(db, "scores"));
    exportRows = [];

    snap.forEach(docSnap => {
      const data = docSnap.data();
      if (data.submitted !== true) return;

      const r = data.rater || {};
      const cats = data.categories || {};

      const ts = data.submittedAt?.toDate?.();
      const timeStr = ts ? ts.toLocaleString() : "";
      const timeMs = ts ? ts.getTime() : 0;

      const row = {
        name: r.name || "",
        dept: r.dept || "",
        title: r.title || "",
        total: data.totalScore ?? 0,
        avg: data.avgScore ?? "",
        time: timeStr,
        timeMs
      };
      CAT_META.forEach(({name}) => {
        const cd = cats[name];
        const a = cd?.scoreA ?? null;
        const b = cd?.scoreB ?? null;

        row[name + "_A"] = a;
        row[name + "_B"] = b;
        row[name + "_SUM"] = (a == null || b == null) ? "" : (a + b);
        row[name + "_comment"] = cd?.comment ?? "";
      });

      exportRows.push(row);
    });

    renderTable();
    updateSortIcons();

    const colCount = 3 + CAT_META.length * (showAB ? 4 : 2) + 2;
    if (exportRows.length === 0) {
      tableBody.innerHTML =
        `<tr><td colspan="${colCount}" style="text-align:center;color:#666;">ç›®å‰æ²’æœ‰ã€Œå·²é€å‡ºã€è³‡æ–™</td></tr>`;
    }
  } catch (err) {
    console.error(err);
    alert("è®€å– Firestore å¤±æ•—ï¼Œè«‹çœ‹ Console");
  }
}

/** ========= Helpers ========= */
function td(text, { preWrap=false, cls="" } = {}) {
  const cell = document.createElement("td");
  cell.textContent = String(text ?? "");
  if (preWrap) cell.classList.add("prewrap");

  // âœ… cls å¯ç‚ºå­—ä¸²æˆ–é™£åˆ—
  if (Array.isArray(cls)) cls.forEach(c => c && cell.classList.add(c));
  else if (cls) cell.classList.add(cls);

  return cell;
}

function th(text, { key=null, cls="", sticky=null, widthCls="" } = {}) {
  const el = document.createElement("th");
  el.textContent = text;

  // âœ… cls å¯ç‚ºå­—ä¸²æˆ–é™£åˆ—
  if (Array.isArray(cls)) cls.forEach(c => c && el.classList.add(c));
  else if (cls) el.classList.add(cls);

  if (widthCls) el.classList.add(widthCls);

  if (sticky === 1) el.classList.add("stickyL","w-name");
  if (sticky === 2) el.classList.add("stickyL","stickyL2","w-dept");
  if (sticky === 3) el.classList.add("stickyL","stickyL3","w-title");

  if (key) {
    el.classList.add("sortable");
    el.dataset.key = key;
    el.addEventListener("click", () => sortBy(key));
  }
  return el;
}

/** ========= Header ========= */
function renderHeader() {
  headerRow.innerHTML = "";

  // å›ºå®šæ¬„ï¼ˆä¹Ÿåšæ’åºå¯é¸ï¼›ä½ è¦å°±æ‰“é–‹ keyï¼‰
  headerRow.appendChild(th("å§“å", { sticky:1 }));
  headerRow.appendChild(th("ç§‘å®¤", { sticky:2 }));
  headerRow.appendChild(th("è·ç¨±", { sticky:3 }));

  // æ¯ä¸€é¡ï¼šAã€Bã€A+Bã€è©•èªï¼ˆåŒè‰²ã€æ’ä¸€èµ·ï¼‰
  CAT_META.forEach(({name, cls}) => {
    if (showAB) {
      headerRow.appendChild(th(`${name} A â†•`, { key: name + "_A", cls:[cls, "numCol"] }));
      headerRow.appendChild(th(`${name} B â†•`, { key: name + "_B", cls:[cls, "numCol"] }));
    }
    headerRow.appendChild(th(`${name} A+B â†•`, { key: name + "_SUM", cls:[cls, "numCol"] }));
    headerRow.appendChild(th(`${name} è©•èª`, { cls:[cls, "commentCol"] }));
  });

  headerRow.appendChild(th("ç¸½åˆ† â†•", { key:"total", cls:["cat-total","totalCol"] }));
  headerRow.appendChild(th("å¹³å‡åˆ† â†•", { key:"avg", cls:"cat-total totalCol" }));
  headerRow.appendChild(th("é€å‡ºæ™‚é–“ â†•", { key:"timeMs", cls:["cat-total","timeCol"] }));
}

/** ========= Table ========= */
function renderTable() {
  tableBody.innerHTML = "";

  exportRows.forEach(row => {
    const tr = document.createElement("tr");

    // å›ºå®šæ¬„
    const tdName = td(row.name, { cls:"w-name" }); tdName.classList.add("stickyL");
    const tdDept = td(row.dept, { cls:"w-dept" }); tdDept.classList.add("stickyL","stickyL2");
    const tdTitle= td(row.title,{ cls:"w-title"}); tdTitle.classList.add("stickyL","stickyL3");
    tr.appendChild(tdName);
    tr.appendChild(tdDept);
    tr.appendChild(tdTitle);

    // åˆ†é¡ç¾¤çµ„
    CAT_META.forEach(({name, cls}) => {
      if (showAB) {
        tr.appendChild(td(row[name + "_A"] ?? "", { cls:[cls, "numCol"] }));
        tr.appendChild(td(row[name + "_B"] ?? "", { cls:[cls, "numCol"] }));
      }
      tr.appendChild(td(row[name + "_SUM"] ?? "", { cls:[cls, "numCol"] }));
      tr.appendChild(td(row[name + "_comment"] ?? "", { cls:[cls, "commentCol"], preWrap:true }));
    });

    tr.appendChild(td(row.total ?? "", { cls:["cat-total","totalCol"] }));
    tr.appendChild(td(row.avg ?? "", { cls:"cat-total totalCol" }));
    tr.appendChild(td(row.time ?? "", { cls:["cat-total","timeCol"] }));

    tableBody.appendChild(tr);
  });
}

/** ========= Sorting ========= */
function sortBy(key) {
  if (sortKey === key) sortAsc = !sortAsc;
  else { sortKey = key; sortAsc = true; }

  exportRows.sort((a, b) => {
    const av = a[key];
    const bv = b[key];

    const aEmpty = av === "" || av === null || typeof av === "undefined";
    const bEmpty = bv === "" || bv === null || typeof bv === "undefined";
    if (aEmpty && bEmpty) return 0;
    if (aEmpty) return 1;
    if (bEmpty) return -1;

    // timeMs / total / A / B / SUM éƒ½æ˜¯æ•¸å­—ï¼Œç›´æ¥æ¯”
    const an = Number(av);
    const bn = Number(bv);
    const bothNum = !Number.isNaN(an) && !Number.isNaN(bn);
    const cmp = bothNum ? (an - bn) : String(av).localeCompare(String(bv));
    return sortAsc ? cmp : -cmp;
  });

  renderTable();
  updateSortIcons();
}

function updateSortIcons() {
  document.querySelectorAll("th.sortable").forEach(thEl => {
    const key = thEl.dataset.key;
    const baseText = thEl.getAttribute("data-label") || thEl.textContent.replace(/[â†‘â†“â†•]\s*$/, "").trim();
    thEl.setAttribute("data-label", baseText);

    if (key === sortKey) thEl.textContent = `${baseText} ${sortAsc ? "â†‘" : "â†“"}`;
    else thEl.textContent = `${baseText} â†•`;
  });
}

/** ========= Toggle A/B ========= */
btnToggleAB.addEventListener("click", () => {
  showAB = !showAB;
  btnToggleAB.textContent = showAB ? "æ”¶èµ· A/B" : "å±•é–‹ A/B";
  renderHeader();
  renderTable();
  updateSortIcons();
});

/** ========= CSV export ========= */
btnExport.addEventListener("click", () => {
  if (exportRows.length === 0) {
    alert("æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™");
    return;
  }

  const headers = ["å§“å","ç§‘å®¤","è·ç¨±"];
  CAT_META.forEach(({name}) => {
    if (showAB) {
      headers.push(`${name}A`, `${name}B`);
    }
    headers.push(`${name}(A+B)`, `${name}è©•èª`);
  });
  headers.push("ç¸½åˆ†","é€å‡ºæ™‚é–“");

  const rows = exportRows.map(r => {
    const line = [r.name, r.dept, r.title];
    CAT_META.forEach(({name}) => {
      if (showAB) line.push(r[name+"_A"] ?? "", r[name+"_B"] ?? "");
      line.push(r[name+"_SUM"] ?? "", r[name+"_comment"] ?? "");
    });
    line.push(r.total ?? "", r.time ?? "");
    return line;
  });

  const escapeCsv = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
  const csvBody = [headers, ...rows].map(line => line.map(escapeCsv).join(",")).join("\n");
  const csvWithBom = "\uFEFF" + csvBody;

  const blob = new Blob([csvWithBom], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "è©•åˆ†åŒ¯å‡º.csv";
  a.click();

  URL.revokeObjectURL(url);
});

// åˆå§‹å…ˆç•«è¡¨é ­ï¼ˆæœªç™»å…¥ä¹Ÿçœ‹å¾—åˆ°æ¬„ä½çµæ§‹ï¼‰
renderHeader();
</script>

</body>
</html>
