<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>臺中市水利局AI小幫手測試-評分結果瀏覽</title>
<style>
  body { font-family: system-ui; margin:20px; }
  table { border-collapse: collapse; width:100%; margin-top:15px; }
  th, td { border:1px solid #ddd; padding:8px; font-size:14px; vertical-align: top; }
  th { background:#f3f4f6; }
  button { padding:8px 14px; font-size:14px; }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { background: #e5e7eb; }
</style>
</head>
<body>

<h2>臺中市水利局AI小幫手測試-評分結果瀏覽</h2>

<div id="loginBox" style="margin:12px 0; padding:12px; border:1px solid #ddd; border-radius:8px; max-width:420px;">
  <div style="display:flex; gap:8px; margin-bottom:8px;">
    <input id="email" placeholder="Admin Email" style="flex:1; padding:8px;">
    <input id="password" placeholder="Password" type="password" style="flex:1; padding:8px;">
  </div>
  <button id="btnLogin">登入</button>
  <button id="btnLogout" style="display:none;">登出</button>
  <span id="loginMsg" style="margin-left:8px; color:#666;"></span>
</div>

<button id="btnExport" disabled>下載 CSV</button>
<button id="btnToggleAB" disabled>展開 A/B</button>
  

<table id="dataTable">
  <thead>
    <tr id="headerRow"></tr>
  </thead>
  <tbody></tbody>
</table>
<script type="module">
import { 
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import { initializeApp } 
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import { 
  getFirestore, collection, getDocs 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/** ========= Firebase init ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBqSDWpIR_Bm2CVdnObkkuopOBrxgoXlH0",
  authDomain: "tcswg-ai-qa.firebaseapp.com",
  projectId: "tcswg-ai-qa"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/** ========= DOM ========= */
const tableBody = document.querySelector("#dataTable tbody");
const btnExport = document.getElementById("btnExport");
const btnToggleAB = document.getElementById("btnToggleAB");

const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const loginMsg = document.getElementById("loginMsg");

/** ========= Data ========= */
const CATEGORIES = [
  "化糞池處理",
  "政策與法規",
  "施工與技術",
  "接管流程與期限",
  "費用與補助"
];

let exportRows = [];
let sortKey = null;
let sortAsc = true;
let showAB = false;

/** ========= Auth UI ========= */
btnLogin.addEventListener("click", async () => {
  loginMsg.textContent = "登入中…";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (e) {
    console.error(e);
    loginMsg.textContent = "登入失敗（帳密錯誤或未開啟 Email/Password）";
  }
});

btnLogout.addEventListener("click", async () => {
  await signOut(auth);
});

onAuthStateChanged(auth, async (user) => {
  // 未登入
  if (!user) {
    loginMsg.textContent = "尚未登入";
    btnLogin.style.display = "";
    btnLogout.style.display = "none";
    btnExport.disabled = true;
    btnToggleAB.disabled = true;

    exportRows = [];
    tableBody.innerHTML = "";
    renderHeader(); // 讓表頭至少存在
    return;
  }

  // 匿名或沒有 email → 不給看（防止前端匿名登入影響 admin）
  if (user.isAnonymous || !user.email) {
    await signOut(auth);
    loginMsg.textContent = "請使用管理員 Email/Password 登入（不接受匿名登入）";
    btnLogin.style.display = "";
    btnLogout.style.display = "none";
    btnExport.disabled = true;
    btnToggleAB.disabled = true;

    exportRows = [];
    tableBody.innerHTML = "";
    renderHeader();
    return;
  }

  // 管理員登入成功
  loginMsg.textContent = `已登入：${user.email}`;
  btnLogin.style.display = "none";
  btnLogout.style.display = "";
  btnExport.disabled = false;
  btnToggleAB.disabled = false;

  // ✅ 先畫表頭（依 showAB 狀態）
  renderHeader();

  // ✅ 再讀資料，loadData 內會 renderTable + updateSortIcons
  await loadData();
});

/** ========= Load ========= */
async function loadData() {
  try {
    const snap = await getDocs(collection(db, "scores"));
    exportRows = [];

    snap.forEach(docSnap => {
      const data = docSnap.data();
      if (data.submitted !== true) return;

      const r = data.rater || {};
      const cats = data.categories || {};

      const row = {
        name: r.name || "",
        dept: r.dept || "",
        title: r.title || "",
        total: data.totalScore ?? 0,
        time: data.submittedAt?.toDate?.().toLocaleString() || ""
      };

      CATEGORIES.forEach(cat => {
        const cd = cats[cat];

        const a = cd?.scoreA ?? null;
        const b = cd?.scoreB ?? null;

        row[cat + "_A"] = a;
        row[cat + "_B"] = b;
        row[cat] = (a == null || b == null) ? "" : (a + b);
        row[cat + "_comment"] = cd?.comment ?? "";
      });

      exportRows.push(row);
    });

    // ✅ 這三個只做一次就好
    renderHeader();
    renderTable();
    updateSortIcons();

    // ✅ 沒資料提示（colspan 要跟 showAB 同步）
    const colCount =
      3 + (showAB ? CATEGORIES.length * 2 : 0) + CATEGORIES.length + CATEGORIES.length + 2;

    if (exportRows.length === 0) {
      tableBody.innerHTML =
        `<tr><td colspan="${colCount}" style="text-align:center;color:#666;">目前沒有「已送出」資料</td></tr>`;
    }
  } catch (err) {
    console.error(err);
    alert("讀取 Firestore 失敗，請看 Console");
  }
}

/** ========= Table render ========= */
function td(text, preWrap = false) {
  const cell = document.createElement("td");
  cell.textContent = String(text ?? "");
  if (preWrap) cell.style.whiteSpace = "pre-wrap";
  return cell;
}

const headerRow = document.getElementById("headerRow");

function renderHeader() {
  headerRow.innerHTML = "";

  const addTh = (text, key = null) => {
    const th = document.createElement("th");
    th.textContent = text;
    if (key) {
      th.classList.add("sortable");
      th.dataset.key = key;
      th.addEventListener("click", () => sortBy(key));
    }
    headerRow.appendChild(th);
  };

  // 固定欄
  addTh("姓名");
  addTh("科室");
  addTh("職稱");

  // 展開 A/B（10欄，不做排序）
  if (showAB) {
    CATEGORIES.forEach(cat => {
      addTh(`${cat} A`);
      addTh(`${cat} B`);
    });
  }

  // A+B 欄（可排序）
  CATEGORIES.forEach(cat => addTh(`${cat} ↕`, cat));

  // 評語
  CATEGORIES.forEach(cat => addTh(`${cat}評語`));

  // 總分（可排序）、送出時間（你要排序的話也可以加 key）
  addTh("總分 ↕", "total");
  addTh("送出時間");
}
function renderTable() {
  tableBody.innerHTML = "";

  exportRows.forEach(row => {
    const tr = document.createElement("tr");

    tr.appendChild(td(row.name));
    tr.appendChild(td(row.dept));
    tr.appendChild(td(row.title));

    if (showAB) {
      CATEGORIES.forEach(cat => {
        tr.appendChild(td(row[cat + "_A"] ?? ""));
        tr.appendChild(td(row[cat + "_B"] ?? ""));
      });
    }

    tr.appendChild(td(row["化糞池處理"] ?? ""));
    tr.appendChild(td(row["政策與法規"] ?? ""));
    tr.appendChild(td(row["施工與技術"] ?? ""));
    tr.appendChild(td(row["接管流程與期限"] ?? ""));
    tr.appendChild(td(row["費用與補助"] ?? ""));

    tr.appendChild(td(row["化糞池處理_comment"] ?? "", true));
    tr.appendChild(td(row["政策與法規_comment"] ?? "", true));
    tr.appendChild(td(row["施工與技術_comment"] ?? "", true));
    tr.appendChild(td(row["接管流程與期限_comment"] ?? "", true));
    tr.appendChild(td(row["費用與補助_comment"] ?? "", true));

    tr.appendChild(td(row.total ?? ""));
    tr.appendChild(td(row.time ?? ""));

    tableBody.appendChild(tr);
  });
}

/** ========= Sorting ========= */
function sortBy(key) {
  if (sortKey === key) sortAsc = !sortAsc;
  else { sortKey = key; sortAsc = true; }

  exportRows.sort((a, b) => {
    const av = a[key] ?? "";
    const bv = b[key] ?? "";

    const aEmpty = av === "" || av === null || typeof av === "undefined";
    const bEmpty = bv === "" || bv === null || typeof bv === "undefined";
    if (aEmpty && bEmpty) return 0;
    if (aEmpty) return 1;
    if (bEmpty) return -1;

    const an = Number(av);
    const bn = Number(bv);
    const cmp = (Number.isNaN(an) || Number.isNaN(bn))
      ? String(av).localeCompare(String(bv))
      : (an - bn);

    return sortAsc ? cmp : -cmp;
  });

  renderTable();
  updateSortIcons();
}

function updateSortIcons() {
  document.querySelectorAll("th.sortable").forEach(th => {
    const key = th.getAttribute("data-key");
    const baseText = th.getAttribute("data-label") || th.textContent.replace(/[↑↓↕]\s*$/, "").trim();
    th.setAttribute("data-label", baseText);

    if (key === sortKey) th.textContent = `${baseText} ${sortAsc ? "↑" : "↓"}`;
    else th.textContent = `${baseText} ↕`;
  });
}

document.querySelectorAll("th.sortable").forEach(th => {
  th.addEventListener("click", () => {
    const key = th.getAttribute("data-key");
    sortBy(key);
  });
});

/** ========= Toggle A/B ========= */
btnToggleAB.addEventListener("click", () => {
  showAB = !showAB;
  btnToggleAB.textContent = showAB ? "收起 A/B" : "展開 A/B";

  renderHeader();
  renderTable();
  updateSortIcons();
});

/** ========= CSV export ========= */
btnExport.addEventListener("click", () => {
  if (exportRows.length === 0) {
    alert("沒有可匯出的資料");
    return;
  }

  const headers = [
    "姓名","科室","職稱",
    ...(showAB ? [
      "化糞池處理A","化糞池處理B",
      "政策與法規A","政策與法規B",
      "施工與技術A","施工與技術B",
      "接管流程與期限A","接管流程與期限B",
      "費用與補助A","費用與補助B",
    ] : []),
    "化糞池處理(A+B)","政策與法規(A+B)","施工與技術(A+B)","接管流程與期限(A+B)","費用與補助(A+B)",
    "化糞池處理評語","政策與法規評語","施工與技術評語","接管流程與期限評語","費用與補助評語",
    "總分","送出時間"
  ];

  const rows = exportRows.map(r => ([
    r.name, r.dept, r.title,
    ...(showAB ? [
      r["化糞池處理_A"] ?? "", r["化糞池處理_B"] ?? "",
      r["政策與法規_A"] ?? "", r["政策與法規_B"] ?? "",
      r["施工與技術_A"] ?? "", r["施工與技術_B"] ?? "",
      r["接管流程與期限_A"] ?? "", r["接管流程與期限_B"] ?? "",
      r["費用與補助_A"] ?? "", r["費用與補助_B"] ?? "",
    ] : []),
    r["化糞池處理"] ?? "", r["政策與法規"] ?? "", r["施工與技術"] ?? "", r["接管流程與期限"] ?? "", r["費用與補助"] ?? "",
    r["化糞池處理_comment"] ?? "", r["政策與法規_comment"] ?? "", r["施工與技術_comment"] ?? "", r["接管流程與期限_comment"] ?? "", r["費用與補助_comment"] ?? "",
    r.total ?? "", r.time ?? ""
  ]));

  const escapeCsv = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
  const csvBody = [headers, ...rows].map(line => line.map(escapeCsv).join(",")).join("\n");
  const csvWithBom = "\uFEFF" + csvBody;

  const blob = new Blob([csvWithBom], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "評分匯出.csv";
  a.click();

  URL.revokeObjectURL(url);
});
</script>


</body>
</html>
