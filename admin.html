<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>臺中市水利局AI小幫手測試-評分結果瀏覽</title>
<style>
  body { font-family: system-ui; margin:20px; }

  /* 外層水平捲動 */
  .tableWrap{
    overflow:auto;
    border:1px solid #e5e7eb;
    border-radius:10px;
    margin-top:15px;
    max-height: 70vh; /* 讓你可以垂直捲動 */
  }

  table { border-collapse: collapse; width: 100%; table-layout: fixed; }
  th, td { border:1px solid #ddd; padding:8px; font-size:14px; vertical-align: top; }
  th { background:#f3f4f6; position: sticky; top: 0; z-index: 2; }

  button { padding:8px 14px; font-size:14px; }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { background: #e5e7eb; }

  /* 分類同色（淡底） */
  .cat-septic  { background: #fff7ed; }
  .cat-policy  { background: #f0f9ff; }
  .cat-const   { background: #f5f3ff; }
  .cat-conn    { background: #f0fdf4; }
  .cat-subsidy { background: #fff1f2; }

  /* 總分/時間 */
  .cat-total   { background: #f9fafb; }

  /* 評語換行 */
  .prewrap { white-space: pre-wrap; }

  /* 固定左三欄（可選，想要就留） */
  th.stickyL, td.stickyL {
    position: sticky;
    left: 0;
    z-index: 3;
    background: #f3f4f6;
  }
  th.stickyL2, td.stickyL2 { left: 90px; }   /* 依欄寬微調 */
  th.stickyL3, td.stickyL3 { left: 220px; }  /* 依欄寬微調 */

  /* 讓左三欄寬度固定好算 sticky */
  .w-name { min-width:90px; }
  .w-dept { min-width:130px; }
  .w-title{ min-width:120px; }

  /* =========================
     ✅ Admin 表格穩定版
     ========================= */
  
  /* 表格固定佈局（關鍵） */
  table {
    width: 100%;
    table-layout: fixed;   /* ⭐ 讓欄寬固定 */
    border-collapse: collapse;
  }
  
  /* 所有儲存格統一處理 */
  th, td {
    padding: 8px 10px;
    border: 1px solid #e5e7eb;
    vertical-align: top;
    word-break: break-word;      /* ⭐ 長字串強制換行 */
    overflow-wrap: anywhere;     /* ⭐ 任何地方都能斷行 */
    white-space: normal;         /* ⭐ 允許自動換行 */
  }
  
  /* =========================
     指定欄寬（可依需求微調）
     ========================= */
  
  
  /* 表格外層可橫向滑動（手機用） */
  .tableWrapper {
    overflow-x: auto;
  }
  /* ✅ 評語欄統一寬度 + 內容顯示 */
  th.commentCol, td.commentCol{
    width: 320px;
    min-width: 320px;
    max-width: 320px;
  }
  
  /* ✅ 讓每格評語不把整列撐爆：固定高度 + 內部捲動 */
  td.commentCol{
    white-space: pre-wrap;      /* 你原本 prewrap 也可以保留，這更直接 */
    word-break: break-word;
    overflow-wrap: anywhere;
  
    height: 140px;              /* 每格一樣高（你可改 120/160） */
    overflow-y: auto;
  }
  
  /* ✅ 數字欄（A/B/A+B）可以窄一點，表格更整齊 */
  th.numCol, td.numCol{
    width: 110px;
    min-width: 110px;
    max-width: 110px;
    text-align: left;
  }
</style>
</head>
<body>

<h2>臺中市水利局AI小幫手測試-評分結果瀏覽</h2>

<div id="loginBox" style="margin:12px 0; padding:12px; border:1px solid #ddd; border-radius:8px; max-width:420px;">
  <div style="display:flex; gap:8px; margin-bottom:8px;">
    <input id="email" placeholder="Admin Email" style="flex:1; padding:8px;">
    <input id="password" placeholder="Password" type="password" style="flex:1; padding:8px;">
  </div>
  <button id="btnLogin">登入</button>
  <button id="btnLogout" style="display:none;">登出</button>
  <span id="loginMsg" style="margin-left:8px; color:#666;"></span>
</div>

<button id="btnExport" disabled>下載 CSV</button>
<button id="btnToggleAB" disabled>展開 A/B</button>

<div class="tableWrap">
  <table id="dataTable">
    <thead>
      <tr id="headerRow"></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged,
  setPersistence, inMemoryPersistence
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import { initializeApp }
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import {
  getFirestore, collection, getDocs
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/** ========= Firebase init ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBqSDWpIR_Bm2CVdnObkkuopOBrxgoXlH0",
  authDomain: "tcswg-ai-qa.firebaseapp.com",
  projectId: "tcswg-ai-qa"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/** ✅ 重點：刷新就要重新登入 → 用 inMemoryPersistence */
await setPersistence(auth, inMemoryPersistence);

/** ========= DOM ========= */
const tableBody = document.querySelector("#dataTable tbody");
const headerRow = document.getElementById("headerRow");

const btnExport = document.getElementById("btnExport");
const btnToggleAB = document.getElementById("btnToggleAB");

const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const loginMsg = document.getElementById("loginMsg");

/** ========= Categories meta ========= */
const CAT_META = [
  { name:"化糞池處理", cls:"cat-septic"  },
  { name:"政策與法規", cls:"cat-policy"  },
  { name:"施工與技術", cls:"cat-const"   },
  { name:"接管流程與期限", cls:"cat-conn" },
  { name:"費用與補助", cls:"cat-subsidy" }
];

let exportRows = [];
let sortKey = null;
let sortAsc = true;
let showAB = false;

/** ========= Auth UI ========= */
btnLogin.addEventListener("click", async () => {
  loginMsg.textContent = "登入中…";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (e) {
    console.error(e);
    loginMsg.textContent = "登入失敗（帳密錯誤或未開啟 Email/Password）";
  }
});

btnLogout.addEventListener("click", async () => {
  await signOut(auth);
});

onAuthStateChanged(auth, async (user) => {
  if (!user || user.isAnonymous || !user.email) {
    loginMsg.textContent = "尚未登入";
    btnLogin.style.display = "";
    btnLogout.style.display = "none";
    btnExport.disabled = true;
    btnToggleAB.disabled = true;

    exportRows = [];
    tableBody.innerHTML = "";
    renderHeader();
    return;
  }

  loginMsg.textContent = `已登入：${user.email}`;
  btnLogin.style.display = "none";
  btnLogout.style.display = "";
  btnExport.disabled = false;
  btnToggleAB.disabled = false;

  renderHeader();
  await loadData();
});

/** ========= Load ========= */
async function loadData() {
  try {
    const snap = await getDocs(collection(db, "scores"));
    exportRows = [];

    snap.forEach(docSnap => {
      const data = docSnap.data();
      if (data.submitted !== true) return;

      const r = data.rater || {};
      const cats = data.categories || {};

      const ts = data.submittedAt?.toDate?.();
      const timeStr = ts ? ts.toLocaleString() : "";
      const timeMs = ts ? ts.getTime() : 0;

      const row = {
        name: r.name || "",
        dept: r.dept || "",
        title: r.title || "",
        total: data.totalScore ?? 0,
        time: timeStr,
        timeMs
      };

      CAT_META.forEach(({name}) => {
        const cd = cats[name];
        const a = cd?.scoreA ?? null;
        const b = cd?.scoreB ?? null;

        row[name + "_A"] = a;
        row[name + "_B"] = b;
        row[name + "_SUM"] = (a == null || b == null) ? "" : (a + b);
        row[name + "_comment"] = cd?.comment ?? "";
      });

      exportRows.push(row);
    });

    renderTable();
    updateSortIcons();

    const colCount = 3 + CAT_META.length * (showAB ? 4 : 2) + 2;
    if (exportRows.length === 0) {
      tableBody.innerHTML =
        `<tr><td colspan="${colCount}" style="text-align:center;color:#666;">目前沒有「已送出」資料</td></tr>`;
    }
  } catch (err) {
    console.error(err);
    alert("讀取 Firestore 失敗，請看 Console");
  }
}

/** ========= Helpers ========= */
function td(text, { preWrap=false, cls="" } = {}) {
  const cell = document.createElement("td");
  cell.textContent = String(text ?? "");
  if (preWrap) cell.classList.add("prewrap");

  // ✅ cls 可為字串或陣列
  if (Array.isArray(cls)) cls.forEach(c => c && cell.classList.add(c));
  else if (cls) cell.classList.add(cls);

  return cell;
}

function th(text, { key=null, cls="", sticky=null, widthCls="" } = {}) {
  const el = document.createElement("th");
  el.textContent = text;

  // ✅ cls 可為字串或陣列
  if (Array.isArray(cls)) cls.forEach(c => c && el.classList.add(c));
  else if (cls) el.classList.add(cls);

  if (widthCls) el.classList.add(widthCls);

  if (sticky === 1) el.classList.add("stickyL","w-name");
  if (sticky === 2) el.classList.add("stickyL","stickyL2","w-dept");
  if (sticky === 3) el.classList.add("stickyL","stickyL3","w-title");

  if (key) {
    el.classList.add("sortable");
    el.dataset.key = key;
    el.addEventListener("click", () => sortBy(key));
  }
  return el;
}

/** ========= Header ========= */
function renderHeader() {
  headerRow.innerHTML = "";

  // 固定欄（也做排序可選；你要就打開 key）
  headerRow.appendChild(th("姓名", { sticky:1 }));
  headerRow.appendChild(th("科室", { sticky:2 }));
  headerRow.appendChild(th("職稱", { sticky:3 }));

  // 每一類：A、B、A+B、評語（同色、排一起）
  CAT_META.forEach(({name, cls}) => {
    if (showAB) {
      headerRow.appendChild(th(`${name} A ↕`, { key: name + "_A", cls:[cls, "numCol"] }));
      headerRow.appendChild(th(`${name} B ↕`, { key: name + "_B", cls:[cls, "numCol"] }));
    }
    headerRow.appendChild(th(`${name} A+B ↕`, { key: name + "_SUM", cls:[cls, "numCol"] }));
    headerRow.appendChild(th(`${name} 評語`, { cls:[cls, "commentCol"] }));
  });

  headerRow.appendChild(th("總分 ↕", { key:"total", cls:"cat-total" }));
  headerRow.appendChild(th("送出時間 ↕", { key:"timeMs", cls:"cat-total" }));
}

/** ========= Table ========= */
function renderTable() {
  tableBody.innerHTML = "";

  exportRows.forEach(row => {
    const tr = document.createElement("tr");

    // 固定欄
    const tdName = td(row.name, { cls:"w-name" }); tdName.classList.add("stickyL");
    const tdDept = td(row.dept, { cls:"w-dept" }); tdDept.classList.add("stickyL","stickyL2");
    const tdTitle= td(row.title,{ cls:"w-title"}); tdTitle.classList.add("stickyL","stickyL3");
    tr.appendChild(tdName);
    tr.appendChild(tdDept);
    tr.appendChild(tdTitle);

    // 分類群組
    CAT_META.forEach(({name, cls}) => {
      if (showAB) {
        tr.appendChild(td(row[name + "_A"] ?? "", { cls:[cls, "numCol"] }));
        tr.appendChild(td(row[name + "_B"] ?? "", { cls:[cls, "numCol"] }));
      }
      tr.appendChild(td(row[name + "_SUM"] ?? "", { cls:[cls, "numCol"] }));
      tr.appendChild(td(row[name + "_comment"] ?? "", { cls:[cls, "commentCol"], preWrap:true }));
    });

    tr.appendChild(td(row.total ?? "", { cls:"cat-total" }));
    tr.appendChild(td(row.time ?? "", { cls:"cat-total" }));

    tableBody.appendChild(tr);
  });
}

/** ========= Sorting ========= */
function sortBy(key) {
  if (sortKey === key) sortAsc = !sortAsc;
  else { sortKey = key; sortAsc = true; }

  exportRows.sort((a, b) => {
    const av = a[key];
    const bv = b[key];

    const aEmpty = av === "" || av === null || typeof av === "undefined";
    const bEmpty = bv === "" || bv === null || typeof bv === "undefined";
    if (aEmpty && bEmpty) return 0;
    if (aEmpty) return 1;
    if (bEmpty) return -1;

    // timeMs / total / A / B / SUM 都是數字，直接比
    const an = Number(av);
    const bn = Number(bv);
    const bothNum = !Number.isNaN(an) && !Number.isNaN(bn);
    const cmp = bothNum ? (an - bn) : String(av).localeCompare(String(bv));
    return sortAsc ? cmp : -cmp;
  });

  renderTable();
  updateSortIcons();
}

function updateSortIcons() {
  document.querySelectorAll("th.sortable").forEach(thEl => {
    const key = thEl.dataset.key;
    const baseText = thEl.getAttribute("data-label") || thEl.textContent.replace(/[↑↓↕]\s*$/, "").trim();
    thEl.setAttribute("data-label", baseText);

    if (key === sortKey) thEl.textContent = `${baseText} ${sortAsc ? "↑" : "↓"}`;
    else thEl.textContent = `${baseText} ↕`;
  });
}

/** ========= Toggle A/B ========= */
btnToggleAB.addEventListener("click", () => {
  showAB = !showAB;
  btnToggleAB.textContent = showAB ? "收起 A/B" : "展開 A/B";
  renderHeader();
  renderTable();
  updateSortIcons();
});

/** ========= CSV export ========= */
btnExport.addEventListener("click", () => {
  if (exportRows.length === 0) {
    alert("沒有可匯出的資料");
    return;
  }

  const headers = ["姓名","科室","職稱"];
  CAT_META.forEach(({name}) => {
    if (showAB) {
      headers.push(`${name}A`, `${name}B`);
    }
    headers.push(`${name}(A+B)`, `${name}評語`);
  });
  headers.push("總分","送出時間");

  const rows = exportRows.map(r => {
    const line = [r.name, r.dept, r.title];
    CAT_META.forEach(({name}) => {
      if (showAB) line.push(r[name+"_A"] ?? "", r[name+"_B"] ?? "");
      line.push(r[name+"_SUM"] ?? "", r[name+"_comment"] ?? "");
    });
    line.push(r.total ?? "", r.time ?? "");
    return line;
  });

  const escapeCsv = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
  const csvBody = [headers, ...rows].map(line => line.map(escapeCsv).join(",")).join("\n");
  const csvWithBom = "\uFEFF" + csvBody;

  const blob = new Blob([csvWithBom], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "評分匯出.csv";
  a.click();

  URL.revokeObjectURL(url);
});

// 初始先畫表頭（未登入也看得到欄位結構）
renderHeader();
</script>

</body>
</html>
