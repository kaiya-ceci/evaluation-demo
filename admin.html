<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>評分管理端</title>
<style>
  body { font-family: system-ui; margin:20px; }
  table { border-collapse: collapse; width:100%; margin-top:15px; }
  th, td { border:1px solid #ddd; padding:8px; font-size:14px; vertical-align: top; }
  th { background:#f3f4f6; }
  button { padding:8px 14px; font-size:14px; }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { background: #e5e7eb; }
</style>
</head>
<body>

<h2>評分管理端</h2>

<div id="loginBox" style="margin:12px 0; padding:12px; border:1px solid #ddd; border-radius:8px; max-width:420px;">
  <div style="display:flex; gap:8px; margin-bottom:8px;">
    <input id="email" placeholder="Admin Email" style="flex:1; padding:8px;">
    <input id="password" placeholder="Password" type="password" style="flex:1; padding:8px;">
  </div>
  <button id="btnLogin">登入</button>
  <button id="btnLogout" style="display:none;">登出</button>
  <span id="loginMsg" style="margin-left:8px; color:#666;"></span>
</div>

<button id="btnExport" disabled>下載 CSV</button>

<table id="dataTable">
  <thead>
    <tr>
      <th>姓名</th>
      <th>科室</th>
      <th>職稱</th>
      <th data-key="化糞池處理" class="sortable">化糞池處理 ↕</th>
      <th data-key="政策與法規" class="sortable">政策與法規 ↕</th>
      <th data-key="施工與技術" class="sortable">施工與技術 ↕</th>
      <th data-key="接管流程與期限" class="sortable">接管流程與期限 ↕</th>
      <th data-key="費用與補助" class="sortable">費用與補助 ↕</th>
      <th>化糞池處理評語</th>
      <th>政策與法規評語</th>
      <th>施工與技術評語</th>
      <th>接管流程與期限評語</th>
      <th>費用與補助評語</th>
      <th data-key="total" class="sortable">總分 ↕</th>
      <th data-key="time" class="sortable">送出時間 ↕</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
import { 
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import { initializeApp } 
  from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";

import { 
  getFirestore, collection, getDocs 
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/** ========= Firebase init ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBqSDWpIR_Bm2CVdnObkkuopOBrxgoXlH0",
  authDomain: "tcswg-ai-qa.firebaseapp.com",
  projectId: "tcswg-ai-qa"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/** ========= DOM ========= */
const tableBody = document.querySelector("#dataTable tbody");
const btnExport = document.getElementById("btnExport");

const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const loginMsg = document.getElementById("loginMsg");

/** ========= Data ========= */
const CATEGORIES = [
  "化糞池處理",
  "政策與法規",
  "施工與技術",
  "接管流程與期限",
  "費用與補助"
];

let exportRows = [];
let sortKey = null;
let sortAsc = true;

/** ========= Auth UI ========= */
btnLogin.addEventListener("click", async () => {
  loginMsg.textContent = "登入中…";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (e) {
    console.error(e);
    loginMsg.textContent = "登入失敗（帳密錯誤或未開啟 Email/Password）";
  }
});

btnLogout.addEventListener("click", async () => {
  await signOut(auth);
});

onAuthStateChanged(auth, (user) => {
  if (user) {
    loginMsg.textContent = `已登入：${user.email}`;
    btnLogin.style.display = "none";
    btnLogout.style.display = "";
    btnExport.disabled = false;
    loadData();
  } else {
    loginMsg.textContent = "尚未登入";
    btnLogin.style.display = "";
    btnLogout.style.display = "none";
    btnExport.disabled = true;
    exportRows = [];
    tableBody.innerHTML = "";
  }
});

/** ========= Load / Render ========= */
async function loadData() {
  try {
    const snap = await getDocs(collection(db, "scores"));
    exportRows = [];

    snap.forEach(docSnap => {
      const data = docSnap.data();
      if (data.submitted !== true) return;

      const r = data.rater || {};
      const cats = data.categories || {};

      const row = {
        name: r.name || "",
        dept: r.dept || "",
        title: r.title || "",
        total: data.totalScore ?? 0,
        time: data.submittedAt?.toDate?.().toLocaleString() || ""
      };

      CATEGORIES.forEach(cat => {
        const cd = cats[cat];
        row[cat] = cd ? ((cd.scoreA ?? 0) + (cd.scoreB ?? 0)) : "";
        row[cat + "_comment"] = cd?.comment ?? "";
      });

      exportRows.push(row);
    });

    renderTable();
    updateSortIcons();

    if (exportRows.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="15" style="text-align:center;color:#666;">目前沒有「已送出」資料</td></tr>`;
    }
  } catch (err) {
    console.error(err);
    alert("讀取 Firestore 失敗，請看 Console");
  }
}

function renderTable() {
  tableBody.innerHTML = "";

  exportRows.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="name"></td>
      <td class="dept"></td>
      <td class="title"></td>

      <td class="s1"></td>
      <td class="s2"></td>
      <td class="s3"></td>
      <td class="s4"></td>
      <td class="s5"></td>

      <td class="c1"></td>
      <td class="c2"></td>
      <td class="c3"></td>
      <td class="c4"></td>
      <td class="c5"></td>

      <td class="total"></td>
      <td class="time"></td>
    `;

    tr.querySelector(".name").textContent = row.name || "";
    tr.querySelector(".dept").textContent = row.dept || "";
    tr.querySelector(".title").textContent = row.title || "";

    tr.querySelector(".s1").textContent = row["化糞池處理"] ?? "";
    tr.querySelector(".s2").textContent = row["政策與法規"] ?? "";
    tr.querySelector(".s3").textContent = row["施工與技術"] ?? "";
    tr.querySelector(".s4").textContent = row["接管流程與期限"] ?? "";
    tr.querySelector(".s5").textContent = row["費用與補助"] ?? "";

    tr.querySelector(".c1").textContent = row["化糞池處理_comment"] || "";
    tr.querySelector(".c2").textContent = row["政策與法規_comment"] || "";
    tr.querySelector(".c3").textContent = row["施工與技術_comment"] || "";
    tr.querySelector(".c4").textContent = row["接管流程與期限_comment"] || "";
    tr.querySelector(".c5").textContent = row["費用與補助_comment"] || "";

    tr.querySelectorAll(".c1,.c2,.c3,.c4,.c5").forEach(td => {
      td.style.whiteSpace = "pre-wrap";
    });

    tr.querySelector(".total").textContent = row.total ?? "";
    tr.querySelector(".time").textContent = row.time || "";

    tableBody.appendChild(tr);
  });
}

/** ========= Sorting ========= */
function sortBy(key) {
  if (sortKey === key) sortAsc = !sortAsc;
  else { sortKey = key; sortAsc = true; }

  exportRows.sort((a, b) => {
    const av = a[key] ?? "";
    const bv = b[key] ?? "";

    const aEmpty = av === "" || av === null || typeof av === "undefined";
    const bEmpty = bv === "" || bv === null || typeof bv === "undefined";
    if (aEmpty && bEmpty) return 0;
    if (aEmpty) return 1;
    if (bEmpty) return -1;

    const an = Number(av);
    const bn = Number(bv);
    const cmp = (Number.isNaN(an) || Number.isNaN(bn))
      ? String(av).localeCompare(String(bv))
      : (an - bn);

    return sortAsc ? cmp : -cmp;
  });

  renderTable();
  updateSortIcons();
}

function updateSortIcons() {
  document.querySelectorAll("th.sortable").forEach(th => {
    const key = th.getAttribute("data-key");
    const baseText = th.getAttribute("data-label") || th.textContent.replace(/[↑↓↕]\s*$/, "").trim();
    th.setAttribute("data-label", baseText);

    if (key === sortKey) th.textContent = `${baseText} ${sortAsc ? "↑" : "↓"}`;
    else th.textContent = `${baseText} ↕`;
  });
}

document.querySelectorAll("th.sortable").forEach(th => {
  th.addEventListener("click", () => {
    const key = th.getAttribute("data-key");
    sortBy(key);
  });
});

/** ========= CSV Export ========= */
btnExport.addEventListener("click", () => {
  if (exportRows.length === 0) {
    alert("沒有可匯出的資料");
    return;
  }

  const headers = [
    "姓名","科室","職稱",
    "化糞池處理","政策與法規","施工與技術","接管流程與期限","費用與補助",
    "化糞池處理評語","政策與法規評語","施工與技術評語","接管流程與期限評語","費用與補助評語",
    "總分","送出時間"
  ];

  const rows = exportRows.map(r => [
    r.name, r.dept, r.title,
    r["化糞池處理"], r["政策與法規"], r["施工與技術"], r["接管流程與期限"], r["費用與補助"],
    r["化糞池處理_comment"], r["政策與法規_comment"], r["施工與技術_comment"], r["接管流程與期限_comment"], r["費用與補助_comment"],
    r.total, r.time
  ]);

  const escapeCsv = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
  const csvBody = [headers, ...rows].map(line => line.map(escapeCsv).join(",")).join("\n");
  const csvWithBom = "\uFEFF" + csvBody;

  const blob = new Blob([csvWithBom], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "評分匯出.csv";
  a.click();

  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
